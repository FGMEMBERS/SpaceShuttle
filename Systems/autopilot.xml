<?xml version="1.0"?>

<system>

	<!-- This contains AP routines for the orbital DAP set to 'Auto' -->
 	<!--  for auto-launch, entry and TAEM--> 

	<!-- Orbital DAP largely follows the universal pointing menu -->
	<!-- the main mode is given by up-mnvr-flag,  modes are -->

	<!-- 1: MNVR (maneuver to a specified inertial attitude) -->
	<!-- 2: TRK  (track a specified location) -->
	<!-- 3: ROT  (hold current axis and rotate around it) -->
	<!-- 0: CNCL (cancel the current maneuver) -->

	<!-- the OMS maneuver uses oms-mnvr-flag instead, modes are -->

	<!-- 1: BURN ATT (maneuver to burn attitude) -->
	<!-- 0: CNCL (cancel manever)-->

	<!-- For track and rotation, the body vector can be defined as body-vector-selection -->
	
	<!-- 1: +X -->
	<!-- 2: -X -->
	<!-- 3: -Z (from the payload bay upward) -->

	<channel name="Rates and deadbands config">

		<switch name="systems/ap/rot-rate-degps">
			<default value="0.0"/>
			<test logic="OR" value="3.0">
				systems/fcs/control-mode == 11	
				systems/fcs/control-mode == 12	
				systems/fcs/control-mode == 13	
			</test>
			<test logic="OR" value="systems/ap/spec20/dap-A-PRI-rot-rate">
				systems/fcs/control-mode == 20	
				systems/fcs/control-mode == 26	
				systems/fcs/control-mode == 27	
				systems/fcs/control-mode == 28			
			</test>
			<test value="systems/ap/spec20/dap-A-VRN-rot-rate">
				systems/fcs/control-mode == 25
			</test>
			<test value="systems/ap/spec20/dap-B-PRI-rot-rate">
				systems/fcs/control-mode == 21	
			</test>
			<test value="systems/ap/spec20/dap-B-VRN-rot-rate">
				systems/fcs/control-mode == 30	
			</test>
			<test logic="OR" value="2.0">
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 29		
			</test>
		</switch>

		<switch name="systems/ap/att-db-deg">
			<default value="0.0"/>
			<test logic="OR" value="0.12">
				systems/fcs/control-mode == 11	
				systems/fcs/control-mode == 12	
				systems/fcs/control-mode == 13	
			</test>
			<test logic="OR" value="systems/ap/spec20/dap-A-PRI-att-db">
				systems/fcs/control-mode == 20
				systems/fcs/control-mode == 26	
				systems/fcs/control-mode == 27	
				systems/fcs/control-mode == 28			
			</test>
			<test value="systems/ap/spec20/dap-A-VRN-att-db">
				systems/fcs/control-mode == 25
			</test>
			<test value="systems/ap/spec20/dap-B-PRI-att-db">
				systems/fcs/control-mode == 21	
			</test>
			<test value="systems/ap/spec20/dap-B-VRN-att-db">
				systems/fcs/control-mode == 30	
			</test>
			<test logic="OR" value="0.01">
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 29		
			</test>
		</switch>

		<fcs_function name="systems/ap/att-db-rad">
		<function>
			<product>
				<property>systems/ap/att-db-deg</property>
				<value>0.0174532</value>
			</product>
		</function>	
		</fcs_function>

		<switch name="systems/ap/rate-db-degps">
			<default value="0.0"/>
			<test logic="OR" value="0.01">
				systems/fcs/control-mode == 11	
				systems/fcs/control-mode == 12
				systems/fcs/control-mode == 13		
			</test>
			<test logic="OR" value="systems/ap/spec20/dap-A-PRI-rate-db">
				systems/fcs/control-mode == 20	
				systems/fcs/control-mode == 26	
				systems/fcs/control-mode == 27
				systems/fcs/control-mode == 28				
			</test>
			<test value="systems/ap/spec20/dap-A-VRN-rate-db">
				systems/fcs/control-mode == 25
			</test>
			<test value="systems/ap/spec20/dap-B-PRI-rate-db">
				systems/fcs/control-mode == 21	
			</test>
			<test value="systems/ap/spec20/dap-B-VRN-rate-db">
				systems/fcs/control-mode == 30	
			</test>
			<test logic="OR" value="0.01">
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 29		
			</test>
		</switch>

		<switch name="systems/ap/rot-pls-degps">
			<default value="0.0"/>
			<test  value="systems/ap/spec20/dap-A-PRI-rot-pls">
				systems/fcs/control-mode == 1				
			</test>
		</switch>

	</channel>	


	<channel name="Inertial vector tracking">

		<fcs_function name="systems/ap/track/body-minus-x[0]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-x[0]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/track/body-minus-x[1]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-x[1]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/track/body-minus-x[2]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-x[2]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/track/body-minus-y[0]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-y[0]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/track/body-minus-y[1]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-y[1]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/track/body-minus-y[2]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-y[2]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/track/body-minus-z[0]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-z[0]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/track/body-minus-z[1]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-z[1]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/track/body-minus-z[2]">
		<function>
			<product>
				<property>systems/pointing/inertial/body-z[2]</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/ap/track/body-vector[0]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-x[0]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-x[0]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/pointing/inertial/body-z[0]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/body-vector[1]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-x[1]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-x[1]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/pointing/inertial/body-z[1]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/body-vector[2]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-x[2]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-x[2]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/pointing/inertial/body-z[2]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>


		<switch name="systems/ap/track/body-yaw[0]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-y[0]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-y[0]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/pointing/inertial/body-y[0]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/body-yaw[1]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-y[1]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-y[1]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/pointing/inertial/body-y[1]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/body-yaw[2]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-y[2]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-y[2]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/pointing/inertial/body-y[2]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/body-pitch[0]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-z[0]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-z[0]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/ap/track/body-minus-x[0]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/body-pitch[1]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-z[1]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-z[1]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/ap/track/body-minus-x[1]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/body-pitch[2]">
			<default value="0.0"/>
			<test value="systems/pointing/inertial/body-z[2]">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/body-minus-z[2]">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/ap/track/body-minus-x[2]">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<fcs_function name="systems/ap/att-db-rad-sin">
		<function>
			<sin><property>systems/ap/att-db-rad</property></sin>
		</function>
		</fcs_function>



		<fcs_function name="systems/ap/track/pitch-error">
		<function>
			<sum>
				<product>
					<property>systems/ap/track/body-pitch[0]</property>
					<property>systems/ap/track/target-vector[0]</property>
				</product>
				<product>
					<property>systems/ap/track/body-pitch[1]</property>
					<property>systems/ap/track/target-vector[1]</property>
				</product>
				<product>
					<property>systems/ap/track/body-pitch[2]</property>
					<property>systems/ap/track/target-vector[2]</property>
				</product>
			</sum>
		</function>
		</fcs_function>	

		<fcs_function name="systems/ap/track/pitch-error-deg">
		<function>
			<product>
				<asin>
					<property>systems/ap/track/pitch-error</property>
				</asin>
				<value>57.2974</value>
			</product>
		</function>
		</fcs_function>	


  		<deadband name="systems/ap/track/pitch-error-db">
			<input>systems/ap/track/pitch-error</input>
			<width>systems/ap/att-db-rad-sin</width>
  		</deadband>



		<fcs_function name="systems/ap/track/yaw-error">
		<function>
			<sum>
				<product>
					<property>systems/ap/track/body-yaw[0]</property>
					<property>systems/ap/track/target-vector[0]</property>
				</product>
				<product>
					<property>systems/ap/track/body-yaw[1]</property>
					<property>systems/ap/track/target-vector[1]</property>
				</product>
				<product>
					<property>systems/ap/track/body-yaw[2]</property>
					<property>systems/ap/track/target-vector[2]</property>
				</product>
			</sum>
		</function>
		</fcs_function>	

		<fcs_function name="systems/ap/track/yaw-error-deg">
		<function>
			<product>
				<asin>
					<property>systems/ap/track/yaw-error</property>
				</asin>
				<value>57.2974</value>
			</product>
		</function>
		</fcs_function>	
		

  		<deadband name="systems/ap/track/yaw-error-db">
			<input>systems/ap/track/yaw-error</input>
			<width>systems/ap/att-db-rad-sin</width>
  		</deadband>


		<fcs_function name="systems/ap/track/roll-sine">
		<function>
			<sum>
				<product>
					<property>systems/ap/track/body-yaw[0]</property>
					<property>systems/ap/track/target-sec[0]</property>
				</product>
				<product>
					<property>systems/ap/track/body-yaw[1]</property>
					<property>systems/ap/track/target-sec[1]</property>
				</product>
				<product>
					<property>systems/ap/track/body-yaw[2]</property>
					<property>systems/ap/track/target-sec[2]</property>
				</product>
			</sum>
		</function>
		</fcs_function>	


		<switch name="systems/ap/track/roll-angle-sign">
			<default value="1.0"/>
			<test value="-1.0">
				systems/ap/track/roll-sine GT 0.0
			</test>
		</switch>


		


		<fcs_function name="systems/ap/track/roll-error">
		<function>
			<difference>
			<product>
				<property>systems/ap/track/trk-om</property>
				<value>-0.01745</value>
			</product>
			<product>
			<acos>
			<sum>
				<product>
					<property>systems/ap/track/body-pitch[0]</property>
					<property>systems/ap/track/target-sec[0]</property>
				</product>
				<product>
					<property>systems/ap/track/body-pitch[1]</property>
					<property>systems/ap/track/target-sec[1]</property>
				</product>
				<product>
					<property>systems/ap/track/body-pitch[2]</property>
					<property>systems/ap/track/target-sec[2]</property>
				</product>
			</sum>
			</acos>
			<property>systems/ap/track/roll-angle-sign</property>
			</product>
			</difference>
		</function>
		</fcs_function>	

		<fcs_function name="systems/ap/track/roll-error-deg">
		<function>
			<product>
				<property>systems/ap/track/roll-error</property>
				<value>57.2974</value>
			</product>
		</function>
		</fcs_function>	

		<!-- this is a cheat - the OMS deadband gets too tight by some fluke, so we increase it -->

		<switch name="systems/ap/track/roll-db-correction">
		<default value="0.0"/>
			<test value="0.12">
				systems/ap/oms-mnvr-flag == 1
			</test>
		</switch>


		<fcs_function name="systems/ap/track/roll-db-rad">
		<function>
			<sum>
				<property>systems/ap/att-db-rad</property>
				<property>systems/ap/track/roll-db-correction</property>
			</sum>
		</function>
		</fcs_function>

		<!--<fcs_function name="systems/ap/track/roll-error-abs">
		<function>
			<abs>
				<property>systems/ap/track/roll-error</property>
			</abs>
		</function>
		</fcs_function>

		<switch name="systems/ap/track/roll-error-db">
			<default value="systems/ap/track/roll-error"/>
			<test value="0.0">
				systems/ap/track/roll-error-abs LT systems/ap/att-db-rad
			</test>
		</switch>-->


  		<deadband name="systems/ap/track/roll-error-db">
			<input>systems/ap/track/roll-error</input>
			<width>systems/ap/track/roll-db-rad</width>
  		</deadband>

		<fcs_function name="systems/ap/track/total-attitude-error">
		<function>
			<sum>
				<abs><property>systems/ap/track/yaw-error</property></abs>
				<abs><property>systems/ap/track/pitch-error</property></abs>
				<abs><property>systems/ap/track/roll-error-db</property></abs>
			</sum>
		</function>
		</fcs_function>

		<switch name="systems/ap/track/in-attitude">
			<default value="0.0"/>
			<test value="1.0">
				systems/ap/track/total-attitude-error LT 0.1	
			</test>
		</switch>


		<switch name="systems/ap/track/pitch-error-sense">
			<default value="0.0"/>
			<test value="systems/ap/track/pitch-error-db">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/pitch-error-db">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/ap/track/pitch-error-db">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/yaw-error-sense">
			<default value="0.0"/>
			<test value="systems/ap/track/yaw-error-db">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/yaw-error-db">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/ap/track/roll-error-db">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<switch name="systems/ap/track/roll-error-sense">
			<default value="0.0"/>
			<test value="systems/ap/track/roll-error-db">
				systems/ap/track/body-vector-selection == 1	
			</test>
			<test value="systems/ap/track/roll-error-db">
				systems/ap/track/body-vector-selection == 2	
			</test>
			<test value="systems/ap/track/yaw-error-db">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<fcs_function name="systems/ap/track/pitch-rate-cmd">
		<function>
			<product>
				<min>
				<max>
					<product>
						<property>systems/ap/track/pitch-error-sense</property>
						<value>3.0</value>
					</product>
					<value>-1.0</value>
				</max>
				<value>1.0</value>
				</min>
				<property>systems/ap/rot-rate-degps</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/ap/track/roll-veto-active">
			<default value="1.0"/>
			<test value="0.0">
				systems/ap/track/body-vector-selection == 3	
			</test>
		</switch>

		<fcs_function name="systems/ap/track/yaw-rate-cmd">
		<function>
			<product>
				<min>
				<max>
					<product>
						<property>systems/ap/track/yaw-error-sense</property>
						<value>3.0</value>
					</product>
					<value>-1.0</value>
				</max>
				<value>1.0</value>
				</min>
				<property>systems/ap/rot-rate-degps</property>
				<difference>
					<value>1.0</value>
					<product>
					<abs>
						<quotient>
						<property>systems/ap/track/pitch-rate-cmd</property>
						<max>
						<property>systems/ap/rot-rate-degps</property>
						<value>0.001</value>
						</max>
						</quotient>
					</abs>
					<difference>
						<value>1.0</value>
						<property>systems/ap/track/roll-veto-active</property>
					</difference>
					</product>
				</difference>
			</product>
		</function>
		</fcs_function>




		<fcs_function name="systems/ap/track/roll-rate-cmd">
		<function>
			<product>
				<min>
				<max>
					<product>
						<property>systems/ap/track/roll-error-sense</property>
						<value>1.0</value>
					</product>
					<value>-1.0</value>
				</max>
				<value>1.0</value>
				</min>
				<property>systems/ap/rot-rate-degps</property>
				<difference>
					<value>1.0</value>
					<abs>
						<product>
						<quotient>
						<property>systems/ap/track/yaw-rate-cmd</property>
						<max>
						<property>systems/ap/rot-rate-degps</property>
						<value>0.001</value>
						</max>
						</quotient>
						<property>systems/ap/track/roll-veto-active</property>
						</product>
					</abs>
				</difference>
				<difference>
					<value>1.0</value>
					<abs>
						<quotient>
						<property>systems/ap/track/pitch-rate-cmd</property>
						<max>
						<property>systems/ap/rot-rate-degps</property>
						<value>0.001</value>
						</max>
						</quotient>
					</abs>
				</difference>
			</product>
		</function>
		</fcs_function>


	</channel>


	<channel name="Auto rotation rates">

		<switch name="systems/ap/dap-inertial">
			<default value="0.0"/>
			<test logic="OR" value="1.0">
				systems/fcs/control-mode == 11
				systems/fcs/control-mode == 20	
				systems/fcs/control-mode == 21	
				systems/fcs/control-mode == 25
				systems/fcs/control-mode == 30		
			</test>
		</switch>
	
		

		<switch name="systems/ap/auto-rotation-mode">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/dap-inertial == 1
				systems/ap/orbital-dap-auto == 1
			</test>
		</switch>

		<switch name="systems/ap/set-pitch-rate">
			<default value="0.0"/>
			<test logic="OR" value="systems/ap/track/pitch-rate-cmd">
				systems/ap/up-mnvr-flag == 1
				systems/ap/up-mnvr-flag == 2
				systems/ap/oms-mnvr-flag == 1
			</test>
			<test value="0.0">
				systems/ap/up-mnvr-flag == 3
			</test>
		</switch>

		<switch name="systems/ap/set-yaw-rate">
			<default value="0.0"/>
			<test logic="OR" value="systems/ap/track/yaw-rate-cmd">
				systems/ap/up-mnvr-flag == 1
				systems/ap/up-mnvr-flag == 2
				systems/ap/oms-mnvr-flag == 1
			</test>
			<test logic="AND" value="systems/ap/track/yaw-rate-cmd">
				systems/ap/up-mnvr-flag == 3
				systems/ap/track/body-vector-selection == 1
			</test>
			<test logic="AND" value="systems/ap/track/yaw-rate-cmd">
				systems/ap/up-mnvr-flag == 3
				systems/ap/track/body-vector-selection == 2
			</test>
			<test logic="AND" value="systems/ap/rot-rate-degps">
				systems/ap/up-mnvr-flag == 3
				systems/ap/track/body-vector-selection == 3
			</test>
		</switch>

		<switch name="systems/ap/set-roll-rate">
			<default value="0.0"/>
			<test logic="OR" value="systems/ap/track/roll-rate-cmd">
				systems/ap/up-mnvr-flag == 1
				systems/ap/up-mnvr-flag == 2
				systems/ap/oms-mnvr-flag == 1
			</test>
			<test logic="AND" value="systems/ap/rot-rate-degps">
				systems/ap/up-mnvr-flag == 3
				systems/ap/track/body-vector-selection == 1
			</test>
			<test logic="AND" value="systems/ap/rot-rate-degps">
				systems/ap/up-mnvr-flag == 3
				systems/ap/track/body-vector-selection == 2
			</test>
			<test logic="AND" value="systems/ap/track/roll-rate-cmd">
				systems/ap/up-mnvr-flag == 3
				systems/ap/track/body-vector-selection == 3
			</test>
		</switch>

		<fcs_function name="systems/ap/pitch-rate-error">
		<function>
			<difference>
				<product>
				<property>systems/ap/set-pitch-rate</property>
				<value>-0.01745</value>
				</product>
				<property>velocities/q-rad_sec</property>
			</difference>
		</function>
		</fcs_function>

		<pid name="systems/ap/pitch-rate-controller">
			<input>systems/ap/pitch-rate-error</input>
			<kp> 10.0 </kp>
			<ki> 0.0 </ki>
			<kd> 5.0</kd>
			<clipto>
				<min> -1.0 </min>
        			<max>  1.0 </max>
			</clipto>
			<output>systems/ap/test-pitch</output>
  		</pid>

		<fcs_function name="systems/ap/yaw-rate-error">
		<function>
			<difference>
				<product>
				<property>systems/ap/set-yaw-rate</property>
				<value>-0.01745</value>
				</product>
				<property>velocities/r-rad_sec</property>
			</difference>
		</function>
		</fcs_function>

		<pid name="systems/ap/yaw-rate-controller">
			<input>systems/ap/yaw-rate-error</input>
			<kp> 10.0 </kp>
			<ki> 0.0 </ki>
			<kd> 5.0</kd>
			<clipto>
				<min> -1.0 </min>
        			<max>  1.0 </max>
			</clipto>
			<output>systems/ap/test-yaw</output>
  		</pid>

		<fcs_function name="systems/ap/roll-rate-error">
		<function>
			<difference>
				<product>
				<property>systems/ap/set-roll-rate</property>
				<value>0.1166</value>
				</product>
				<property>velocities/p-rad_sec</property>
			</difference>
			
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/roll-rate-controller">
		<function>
			<min>
			<max>
				<product>
					<property>systems/ap/roll-rate-error</property>
					<quotient>
						<value>25.0</value>
						<max>
						<property>systems/ap/rot-rate-degps</property>
						<value>0.01</value>
						</max>
					</quotient>
				</product>
				<value>-1.0</value>
			</max>
			<value>1.0</value>
			</min>
		</function>
		</fcs_function>



	</channel>

	<channel name="LVLH attitude hold" execute="systems/ap/orbital-dap-lvlh">

		<!-- LVLH attitude hold is commanded when controls are idle -->
		<!-- or when controls are translational -->
		
		<switch name="systems/ap/lvlh/rotational-control-input">
			<default value="1"/>
			<test logic="AND" value="0">
				fcs/elevator-cmd-norm == 0
				fcs/rudder-cmd-norm == 0
				fcs/aileron-cmd-norm == 0
			</test>
			<test  value="0">
				systems/fcs/rcs-translation == 1
			</test>
		</switch>
		

		<switch name="systems/ap/lvlh/attitude-hold-cmd">
			<default value="0"/>
			<test logic="AND" value="1">
				systems/ap/orbital-dap-lvlh == 1
				systems/ap/lvlh/rotational-control-input == 0
			</test>
		</switch>

		<!-- unfortunately FG LVLH isn't shuttle LVLH, need to rotate coords to align with orbital track -->

		<fcs_function name="systems/ap/lvlh/transformation-angle-rad">
		<function>
			<product>
				<difference>
					<property>velocities/course-deg</property>
					<value>90.0</value>
				</difference>
				<value>0.01745329</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/lvlh/s">
		<function>
			<sin>
				<property>systems/ap/lvlh/transformation-angle-rad</property>
			</sin>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/lvlh/c">
		<function>
			<cos>
				<property>systems/ap/lvlh/transformation-angle-rad</property>
			</cos>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/lvlh/body-x[0]">
		<function>
			<sum>
				<product>
					<property>systems/pointing/lvlh/body-x[1]</property>
					<property>systems/ap/lvlh/s</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-x[0]</property>
					<property>systems/ap/lvlh/c</property>
				</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/lvlh/body-x[1]">
		<function>
			<sum>
				<product>
					<property>systems/pointing/lvlh/body-x[1]</property>
					<property>systems/ap/lvlh/c</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-x[0]</property>
					<property>systems/ap/lvlh/s</property>
					<value>-1.0</value>
				</product>
			</sum>
		</function>
		</fcs_function>



		<fcs_function name="systems/ap/lvlh/body-y[0]">
		<function>
			<sum>
				<product>
					<property>systems/pointing/lvlh/body-y[1]</property>
					<property>systems/ap/lvlh/s</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-y[0]</property>
					<property>systems/ap/lvlh/c</property>
				</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/lvlh/body-y[1]">
		<function>
			<sum>
				<product>
					<property>systems/pointing/lvlh/body-y[1]</property>
					<property>systems/ap/lvlh/c</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-y[0]</property>
					<property>systems/ap/lvlh/s</property>
					<value>-1.0</value>
				</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/lvlh/body-z[0]">
		<function>
			<sum>
				<product>
					<property>systems/pointing/lvlh/body-z[1]</property>
					<property>systems/ap/lvlh/s</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-z[0]</property>
					<property>systems/ap/lvlh/c</property>
				</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/lvlh/body-z[1]">
		<function>
			<sum>
				<product>
					<property>systems/pointing/lvlh/body-z[1]</property>
					<property>systems/ap/lvlh/c</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-z[0]</property>
					<property>systems/ap/lvlh/s</property>
					<value>-1.0</value>
				</product>
			</sum>
		</function>
		</fcs_function>


		<!-- sample-hold current pitch, yaw and roll in Shuttle LVLH -->

		<switch name="systems/ap/lvlh/target-vector-pitch[0]">
			<default value="systems/ap/lvlh/body-z[0]"/>
			<test value="systems/ap/lvlh/target-vector-pitch[0]">
				systems/ap/lvlh/attitude-hold-cmd == 1
			</test>
		</switch>

		<switch name="systems/ap/lvlh/target-vector-pitch[1]">
			<default value="systems/ap/lvlh/body-z[1]"/>
			<test value="systems/ap/lvlh/target-vector-pitch[1]">
				systems/ap/lvlh/attitude-hold-cmd == 1
			</test>
		</switch>

		<switch name="systems/ap/lvlh/target-vector-pitch[2]">
			<default value="systems/pointing/lvlh/body-z[2]"/>
			<test value="systems/ap/lvlh/target-vector-pitch[2]">
				systems/ap/lvlh/attitude-hold-cmd == 1
			</test>
		</switch>

		<switch name="systems/ap/lvlh/target-vector-yaw[0]">
			<default value="systems/ap/lvlh/body-y[0]"/>
			<test value="systems/ap/lvlh/target-vector-yaw[0]">
				systems/ap/lvlh/attitude-hold-cmd == 1
			</test>
		</switch>

		<switch name="systems/ap/lvlh/target-vector-yaw[1]">
			<default value="systems/ap/lvlh/body-y[1]"/>
			<test value="systems/ap/lvlh/target-vector-yaw[1]">
				systems/ap/lvlh/attitude-hold-cmd == 1
			</test>
		</switch>

		<switch name="systems/ap/lvlh/target-vector-yaw[2]">
			<default value="systems/pointing/lvlh/body-y[2]"/>
			<test value="systems/ap/lvlh/target-vector-yaw[2]">
				systems/ap/lvlh/attitude-hold-cmd == 1
			</test>
		</switch>

		<switch name="systems/ap/lvlh/roll-sample-hold-deg">
			<default value="/orientation/roll-deg"/>
			<test value="systems/ap/lvlh/roll-sample-hold-deg">
				systems/ap/lvlh/attitude-hold-cmd == 1
			</test>
		</switch>

		<fcs_function name="systems/ap/lvlh/pitch-error">
		<function>
			<sum>
				<product>
					<property>systems/ap/lvlh/body-x[0]</property>
					<property>systems/ap/lvlh/target-vector-pitch[0]</property>
				</product>
				<product>
					<property>systems/ap/lvlh/body-x[1]</property>
					<property>systems/ap/lvlh/target-vector-pitch[1]</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-x[2]</property>
					<property>systems/ap/lvlh/target-vector-pitch[2]</property>
				</product>
			
			</sum>
		</function>
		</fcs_function>	

		<fcs_function name="systems/ap/lvlh/yaw-error">
		<function>
			<sum>
				<product>
					<property>systems/ap/lvlh/body-x[0]</property>
					<property>systems/ap/lvlh/target-vector-yaw[0]</property>
				</product>
				<product>
					<property>systems/ap/lvlh/body-x[1]</property>
					<property>systems/ap/lvlh/target-vector-yaw[1]</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-x[2]</property>
					<property>systems/ap/lvlh/target-vector-yaw[2]</property>
				</product>
			
			</sum>
		</function>
		</fcs_function>	


		<fcs_function name="systems/ap/lvlh/roll-error">
		<function>
			<difference>
				<property>/orientation/roll-deg</property>
				<property>systems/ap/lvlh/roll-sample-hold-deg</property>
			</difference>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/lvlh/pitch-rate-cmd">
		<function>
				<min>
				<max>
					<product>
						<property>systems/ap/lvlh/pitch-error</property>
						<value>10.0</value>
						<property>systems/fcs/rcs-vernier-gain</property>
						<property>systems/ap/orbital-dap-lvlh</property>
					</product>
					<value>-1.0</value>
				</max>
				<value>1.0</value>
				</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/lvlh/yaw-rate-cmd">
		<function>
				<min>
				<max>
					<product>
						<property>systems/ap/lvlh/yaw-error</property>
						<value>10.0</value>
						<property>systems/fcs/rcs-vernier-gain</property>
						<property>systems/ap/orbital-dap-lvlh</property>
					</product>
					<value>-1.0</value>
				</max>
				<value>1.0</value>
				</min>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/lvlh/roll-rate-cmd">
		<function>
				<min>
				<max>
					<product>
						<property>systems/ap/lvlh/roll-error</property>
						<value>-0.1</value>
						<property>systems/fcs/rcs-vernier-gain</property>
						<property>systems/ap/orbital-dap-lvlh</property>
					</product>
					<value>-1.0</value>
				</max>
				<value>1.0</value>
				</min>
		</function>
		</fcs_function>

	</channel>
	
	<!-- OPS 304, 305 and 602 automatic entry and TAEM -->

	
	
	<!-- auto-entry/TAEM - guidance targets are fed by a Nasal script -->

	<!-- general mode selection parameters activating the channels -->

	<channel name="Auto entry and TAEM glide management">

		<switch name="systems/ap/auto-entry-active">
			<default value="0.0"/>
			<test value="1.0">
				systems/dps/major-mode == 304
				systems/fcs/control-mode == 29
			</test>
		</switch>

		<switch name="systems/ap/alpha-hold-mode">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/automatic-pitch-control == 1
				systems/fcs/control-mode == 29
				systems/dps/major-mode == 304
			</test>
		</switch>

		<switch name="systems/ap/auto-taem-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/dps/major-mode == 305
				systems/ap/taem/auto-taem-master == 1
				systems/fcs/control-mode == 29
			</test>
			<test logic="AND" value="1.0">
				systems/dps/major-mode == 602
				systems/ap/taem/auto-taem-master == 1
				systems/fcs/control-mode == 29
				systems/ap/grtls/taem-transition-init == 1
			</test>
		</switch>

	</channel>

	<!-- automatic entry  - roll reversals are commanded by Nasal high-level code-->

	<channel name="Entry autopilot" execute="systems/ap/auto-entry-active">

		

		<switch name="systems/ap/entry/drag-management-init">
			<default value="0"/>
			<test value="1">
				aero/qbar-psf GT 40.0
			</test>
		</switch>

		<fcs_function name="systems/ap/entry/vspeed-target-fps">
		<function>
			<sum>
			<value>230.0</value>
			<product>		
				<property>systems/entry_guidance/v-error-fps</property>
				<value>-0.2</value>
			</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/entry/vspeed-error">
		<function>
			<quotient>
			<max>
				<min>
				<product>
					<difference>
						<property>systems/ap/entry/vspeed-target-fps</property>
						<property>velocities/v-down-fps</property>
					</difference>
					<value>1.0</value>
					</product>
				<value>100.0</value>
				</min>
			<value>-100.0</value>
			</max>
			<value>100.0</value>
			</quotient>
		</function>
		</fcs_function>

  		<deadband name="systems/ap/entry/abs-bank-target-trigger">
			<input>systems/ap/entry/vspeed-error</input>
			<width>0.5</width>
  		</deadband>

		<pid name="systems/ap/entry/abs-bank-modifier-deg">
			<input>systems/ap/entry/vspeed-error</input>
			<kp> 60.0 </kp>
			<ki> 1.0 </ki>
			<kd> 60.0</kd>
			<trigger>systems/ap/entry/abs-bank-target-trigger</trigger>
			<clipto>
				<min> -60.0</min>
        			<max>  15.0 </max>
			</clipto>
  		</pid>

		<fcs_function name="systems/ap/entry/drag-bank-angle-target-deg">
		<function>
			<product>
			<sum>
				<value>60.0</value>
				<property>systems/ap/entry/abs-bank-modifier-deg</property>
			</sum>
			<property>systems/ap/entry/roll-sign</property>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/entry/low-e-bank-angle-target-deg">
		<function>
			<product>
				<value>-2.2</value>
				<property>systems/entry_guidance/delta-azimuth-deg</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/ap/entry/bank-angle-target-deg">
			<default value="systems/ap/entry/drag-bank-angle-target-deg"/>
			<test logic="OR" value="0.0">
				systems/ap/entry/taem-transit-init == 1
				systems/ap/entry/drag-management-init == 0
			</test>
			<test value="systems/ap/entry/low-e-bank-angle-target-deg">
				systems/ap/entry/low-energy-logic == 1
			</test>
			<test value="systems/ap/entry/reversal-bank-angle-target-deg">
				systems/ap/entry/roll-reversal-init == 1
			</test>
		</switch>


		<fcs_function name="systems/ap/entry/bank-angle-error">
		<function>
			<max>
			<min>
			<quotient>
			<difference>
				<property>systems/ap/entry/bank-angle-target-deg</property>
				<property>/orientation/roll-deg</property>
			</difference>
			<value>20.0</value>
			</quotient>
			<value>1.0</value>
			</min>
			<value>-1.0</value>
			</max>
		</function>
		</fcs_function>

		<switch name="systems/ap/entry/roll-gain">
			<default value="0.1"/>
			<test value="0.2">
				systems/ap/entry/roll-reversal-init == 1
			</test>
		</switch>


		<fcs_function name="systems/ap/entry/entry-controller-aileron-cmd-norm">
		<function>
			<product>
				<property>systems/ap/entry/bank-angle-error</property>
				<property>systems/ap/entry/roll-gain</property>
			</product>
		</function>
		</fcs_function>


		<!-- pitch channel including alpha  hold and fast drag modulation -->


		<switch name="systems/ap/entry/fast-drag-modulation-factor">
			<default value="0.0"/>
			<test value="0.0">
				systems/ap/entry/drag-management-init == 0
			</test>
			<test logic="AND" value="1.0">
				accelerations/hdotdot-ft_s2 GT 0.0
				systems/entry_guidance/v-error-fps GT 0.0
			</test>
			<test logic="AND" value="-1.0">
				accelerations/hdotdot-ft_s2 LT 0.0
				systems/entry_guidance/v-error-fps LT 0.0
			</test>
		</switch>

		<fcs_function name="systems/ap/entry/fast-drag-vspeed-error">
		<function>
			<quotient>
			<max>
				<min>
					<difference>
						<property>systems/ap/entry/vspeed-target-fps</property>
						<property>velocities/v-down-fps</property>
					</difference>
				<value>30.0</value>
				</min>
			<value>-30.0</value>
			</max>
			<value>30.0</value>
			</quotient>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/entry/fast-drag-dalpha-rad">
		<function>
			<sum>
			<product>
				<difference>
					<value>1.0</value>
					<property>systems/ap/entry/low-energy-logic</property>
				</difference>
				<value>0.052358333</value>
				<property>systems/ap/entry/fast-drag-vspeed-error</property>
				<property>systems/ap/entry/fast-drag-modulation-factor</property>
			</product>
			<product>
				<value>-0.05235987</value>
				<property>systems/ap/entry/low-energy-logic</property>
			</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/entry/drag-target-alpha-rad">
		<function>
			<sum>
				<property>systems/entry_guidance/nominal-alpha-rad</property>	
				<property>systems/ap/entry/fast-drag-dalpha-rad</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/entry/roll-abs-deg">
		<function>
			<abs>
				<property>/orientation/roll-deg</property>
			</abs>
		</function>
		</fcs_function>
		

		<switch name="systems/ap/entry/alpha-target-rad">
			<default value="systems/ap/entry/drag-target-alpha-rad"/>
			<test logic="AND" value="0.08726">
				systems/ap/entry/taem-transit-init == 1
				systems/ap/entry/roll-abs-deg LT 2.0
			</test>
		</switch>


		<fcs_function name="systems/ap/alpha-error">
		<function>
			<difference>
				<property>systems/ap/entry/alpha-target-rad</property>
				<property>aero/alpha-rad</property>
			</difference>
		</function>
		</fcs_function>

  		<deadband name="systems/ap/alpha-error-trigger">
			<input>systems/ap/alpha-error</input>
			<width>0.01</width>
  		</deadband>

  		<pid name="systems/ap/alpha-controller">
			<input>systems/ap/alpha-error</input>
			<kp> 10.0 </kp>
			<ki> 1.0 </ki>
			<kd> 5.0</kd>
			<trigger>systems/ap/alpha-error-trigger</trigger>
			<clipto>
				<min> -1.0 </min>
        			<max>  1.0 </max>
			</clipto>
  		</pid>


		<fcs_function name="systems/ap/alpha-controller-elevator-cmd-norm">
		<function>
			<product>
				<value>-1</value>
				<property>systems/ap/alpha-controller</property>
				<property>systems/ap/alpha-hold-mode</property>
			</product>
		</function>
		</fcs_function>

	</channel>

	<!-- TAEM guidance targets feed into aerojet DAP -->
	<!-- they're mostly descent rate acquire/hold and direction acquire/hold -->
	<!-- the higher level energy management is done by Nasal -->

	<channel name="TAEM auto-glide" execute="systems/ap/auto-taem-active">

		<fcs_function name="systems/ap/taem/vspeed-target">
		<function>
			<min>
			<sum>
			<value>50.0</value>
			<product>
				<property>systems/ap/taem/hac-turn-init</property>
				<value>40.0</value>
			</product>
			<product>
				<property>velocities/mach</property>
				<value>50.0</value>
			</product>
			<product>	
				<value>-0.02</value>			
				<property>systems/taem-guidance/glideslope-deviation-ft</property>
			</product>
			<product>
				<value>-40.0</value>
				<sin>
					<abs>
						<property>attitude/roll-rad</property>
					</abs>
				</sin>
			</product>
			<product>
			<max>
				<difference>	
					<value>235.0</value>
					<property>velocities/ve-kts</property>
				</difference>
				<value>0.0</value>
			</max>
			<value>15.0</value>
			</product>			
			</sum>
			<value>370.0</value>
			</min>
		</function>
		</fcs_function>	


		<fcs_function name="systems/ap/taem/vspeed-error">
		<function>
	
			<product>
				<difference>
					<property>systems/ap/taem/vspeed-target</property>
					<property>velocities/v-down-fps</property>
				</difference>
				<value>0.005</value>
			</product>
		</function>
		</fcs_function>


 		 <pid name="systems/ap/taem/taem-controller-elevator-cmd-norm">
			<input>systems/ap/taem/vspeed-error</input>
			<kp> 1.0 </kp>
			<ki> 0.0 </ki>
			<kd> 1.5</kd>
			<clipto>
				<min> -0.15 </min>
        			<max>  0.15 </max>
			</clipto>
  		</pid>


		<fcs_function name="systems/ap/taem/az-bank-target">
		<function>
			<max>
			<min>
			<product>
				<property>systems/taem-guidance/delta-azimuth-deg</property>
				<value>10.0</value>
			</product>
			<value>15.0</value>
			</min>
			<value>-15.0</value>
			</max>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/taem/radial-speed-target-fps">
		<function>
			<min>
			<max>
			<product>
				<value>-400.0</value>
				<property>systems/taem-guidance/radial-error-nm</property>
			</product>
			<value>-200.0</value>
			</max>
			<value>200.0</value>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/taem/rdot-error">
		<function>
			<quotient>
			<difference>
				<property>systems/ap/taem/radial-speed-target-fps</property>
				<property>systems/taem-guidance/rdot-fps</property>
			</difference>
			<value>200.0</value>
			</quotient>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/taem/hac-bank-target">
		<function>
			<sum>
			<property>systems/ap/taem/set-bank-target</property>
			<product>
				<property>systems/ap/taem/rdot-error</property>
				<property>systems/ap/taem/set-bank-target</property>
				<value>1.5</value>
			</product>
			</sum>
		</function>
		</fcs_function>

		<switch name="systems/ap/taem/bank-target">
			<default value="systems/ap/taem/az-bank-target"/>
			<test value="systems/ap/taem/hac-bank-target">
				systems/ap/taem/hac-turn-init == 1
			</test>
			<test value="systems/ap/taem/set-bank-target">
				systems/ap/taem/s-turn-init == 1
			</test>
		</switch>

		<fcs_function name="systems/ap/taem/bank-error">
		<function>
	
			<product>
				<difference>
					<property>systems/ap/taem/bank-target</property>
					<property>/orientation/roll-deg</property>
				</difference>
				<value>0.05</value>
			</product>
		</function>
		</fcs_function>


 		 <pid name="systems/ap/taem/taem-controller-aileron-cmd-norm">
			<input>systems/ap/taem/bank-error</input>
			<kp> 1.0 </kp>
			<ki> 0.0 </ki>
			<kd> 1.5</kd>
			<clipto>
				<min> -0.5 </min>
        			<max>  0.5 </max>
			</clipto>
  		</pid>



	</channel>



	<!-- OPS 601 automatic RTLS guidance -->



	<!-- general mode selection parameters activating the channels -->

	<channel name="Auto RTLS management">

		<switch name="systems/ap/auto-prtls-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/dps/major-mode == 601
				systems/entry_guidance/guidance-mode == 3
				systems/fcs/control-mode == 10
			</test>
			<test logic="AND" value="1.0">
				systems/dps/major-mode == 601
				systems/entry_guidance/guidance-mode == 3
				systems/fcs/control-mode == 13
			</test>
		</switch>

		<switch name="systems/ap/auto-grtls-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/dps/major-mode == 602
				systems/entry_guidance/guidance-mode == 3
				systems/fcs/control-mode == 29
				systems/ap/grtls/taem-transition-init == 0
			</test>
		</switch>

		<switch name="systems/ap/auto-grtls-rcs-pitch-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/dps/major-mode == 602
				systems/entry_guidance/guidance-mode == 3
				systems/fcs/control-mode == 29
				systems/ap/automatic-pitch-control == 1
			</test>
		</switch>

		<switch name="systems/ap/auto-grtls-rcs-roll-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/dps/major-mode == 602
				systems/entry_guidance/guidance-mode == 3
				systems/fcs/control-mode == 29
				systems/ap/automatic-roll-control == 1
			</test>
		</switch>




		

	</channel>

	<channel name="Auto PRTLS management" execute="systems/ap/auto-prtls-active">


		<fcs_function name="systems/ap/rtls/pitcharound-prop-fraction">
		<function>
			<table>
        		<independentVar lookup="row">systems/abort/engine-fail-time</independentVar>
        		<tableData>
          	 		  0.0	44.0
				 30.0	47.0
				 60.0	47.0
				 90.0	48.0
				120.0	51.0
				150.0	51.0
				180.0	52.0
				210.0	53.0
				240.0	52.0
        		</tableData>
      			</table>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/guid-percent">
		<function>
			<product>
			<max>
				<quotient>
					<difference>
						<property>propulsion/tank/pct-full</property>
						<property>systems/ap/rtls/pitcharound-prop-fraction</property>
					</difference>		
					<difference>
						<value>100.0</value>
						<property>systems/ap/rtls/pitcharound-prop-fraction</property>
					</difference>
				</quotient>
			<value>0.0</value>
			</max>
			<value>100.0</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/outbound-pitch-deg">
		<function>
			<table>
        		<independentVar lookup="row">systems/abort/engine-fail-time</independentVar>
        		<tableData>
          	 		  0.0	60.0
				 30.0	58.0
				 60.0	57.0
				 90.0	56.0
				120.0	49.0	
				150.0	42.0
				180.0	38.0
				210.0	34.0
				240.0	30.0
        		</tableData>
      			</table>
		</function>
		</fcs_function>

	
		<!-- roll definitions -->

		<fcs_function name="systems/ap/rtls/roll-deg-abs">
		<function>
			<abs>
				<property>/orientation/roll-deg</property>
			</abs>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/roll-deg-alt">
		<function>
			<sum>
				<value>360.0</value>
				<property>/orientation/roll-deg</property>
			</sum>
		</function>
		</fcs_function>

		
		<switch name="systems/ap/rtls/roll-deg">
			<default value="/orientation/roll-deg"/>
			<test value="systems/ap/rtls/roll-deg-alt">
				/orientation/roll-deg LT 0.0
			</test>	
		</switch>

		<!-- phase -->

		<switch name="systems/ap/rtls/flyout-active">
			<default value="1.0"/>
			<test value="0.0">
				propulsion/tank/pct-full LT systems/ap/rtls/pitcharound-prop-fraction
			</test>
		</switch>

		<switch name="systems/ap/rtls/flyback-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/rtls/flyout-active == 0
				systems/ap/rtls/roll-deg-abs LT 90.0
				/orientation/pitch-deg LT 70.0
				systems/ap/rtls/powered-pitchdown-active == 0
			</test>
			<test logic="AND" value="1.0">
				systems/ap/rtls/flyback-active == 1
				systems/ap/rtls/powered-pitchdown-active == 0
			</test>
		</switch>
		

		<switch name="systems/ap/rtls/powered-pitcharound-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/rtls/flyout-active == 0
				systems/ap/rtls/flyback-active == 0
				systems/ap/rtls/powered-pitchdown-active == 0
			</test>
		</switch>
		

		<!-- roll -->



		<fcs_function name="systems/ap/rtls/flyout-roll-error">
		<function>
			<difference>
				<property>systems/ap/rtls/roll-deg</property>
				<value>180.0</value>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/flyback-roll-error">
		<function>
			<product>
				<value>1</value>
				<property>/orientation/roll-deg</property>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/ap/rtls/roll-error">
			<default value="0.0"/>
			<test value="systems/ap/rtls/flyout-roll-error">
				systems/ap/rtls/flyout-active == 1
			</test>
			<test value="0.0">
				systems/ap/rtls/powered-pitcharound-active == 1
			</test>
			<test logic="OR" value="systems/ap/rtls/flyback-roll-error">
				systems/ap/rtls/flyback-active == 1
				systems/ap/rtls/powered-pitchdown-active == 1
			</test>
		</switch>

		<fcs_function name="systems/ap/rtls/roll-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/rtls/roll-error</property>
						<value>-0.5</value>
					</product>
					<value>-0.05</value>
				</max>
				<value>0.05</value>
			</min>
		</function>
		</fcs_function>


		<!-- yaw -->



		<fcs_function name="systems/ap/rtls/flyout-yaw-error">
		<function>
			<product>
				<value>-0.2</value>
				<property>aero/beta-deg</property>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/flyback-yaw-error">
		<function>
			<difference>
				<property>/orientation/heading-deg</property>
				<property>systems/entry_guidance/target-azimuth-deg</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/powered-pitchdown-yaw-error">
		<function>
			<product>
				<value>-0.4</value>
				<property>aero/beta-deg</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/ap/rtls/yaw-error">
			<default value="0.0"/>
			<test value="systems/ap/rtls/flyout-yaw-error">
				systems/ap/rtls/flyout-active == 1
			</test>
			<test value="0.0">
				systems/ap/rtls/powered-pitcharound-active == 1
			</test>
			<test value="systems/ap/rtls/flyback-yaw-error">
				systems/ap/rtls/flyback-active == 1
			</test>
			<test value="systems/ap/rtls/powered-pitchdown-yaw-error">
				systems/ap/rtls/powered-pitchdown-active == 1
			</test>
		</switch>

		<fcs_function name="systems/ap/rtls/yaw-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/rtls/yaw-error</property>
						<value>0.1</value>
					</product>
					<value>-0.25</value>
				</max>
				<value>0.25</value>
			</min>
		</function>
		</fcs_function>


		<!-- pitch -->
		<!-- note that due to the different roll orientation pitch error flips sign in PPA -->

		

		<fcs_function name="systems/ap/rtls/flyout-pitch-error">
		<function>
			<difference>
				<property>/orientation/pitch-deg</property>
				<property>systems/ap/rtls/outbound-pitch-deg</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/powered-pitchdown-pitch-error">
		<function>
			<difference>
				<value>-2.0</value>
				<property>aero/alpha-deg</property>
			</difference>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/rtls/flyback-trajectory-deviation">
		<function>
			<min>
			<max>
			<difference>
			<table>
        			<independentVar lookup="row">systems/entry_guidance/site-relative-velocity-fps</independentVar>
        			<tableData>
				-8000.0		265000.0
				-7000.0		260000.0
				-2500.0		270000.0
				    0.0		330000.0
				 3400.0		420000.0
        			</tableData>
      				</table>
			<property>/position/altitude-ft</property>
			</difference>
			<value>-40000.0</value>
			</max>
			<value>40000.0</value>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/flyback-vspead-db-width">
		<function>

			<product>
			<table>
        			<independentVar lookup="row">systems/entry_guidance/site-relative-velocity-fps</independentVar>
        			<tableData>
				-7000.0		100.0
				-2500.0		200.0
				    0.0		300.0
				 3400.0		700.0
        			</tableData>
      			</table>

			<max>
			<quotient>
				<abs>
					<property>systems/ap/rtls/flyback-trajectory-deviation</property>
				</abs>				
				<value>40000.0</value>
			</quotient>
			<value>0.3</value>
			</max>
			</product>
			
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/rtls/vspeed-biased-fps">
		<function>
			<sum>
				<property>velocities/v-down-fps</property>
			<table>
        			<independentVar lookup="row">systems/entry_guidance/site-relative-velocity-fps</independentVar>
        			<tableData>
				-7000.0		150.0
				-5500.0		0.0
				-4500.0		-250.0
				-3500.0		-400.0
				-2500.0		-500.0
				    0.0		-500.0
				 3400.0		-700.0
        			</tableData>
      			</table>
			</sum>
		</function>
		</fcs_function>

  		<deadband name="systems/ap/rtls/vspeed-deadband">
			<input>systems/ap/rtls/vspeed-biased-fps</input>
			<width>systems/ap/rtls/flyback-vspead-db-width</width>
  		</deadband>
		

		<switch name="systems/ap/rtls/flyback-trajectory-damper">
			<default value="0.0"/>
			<test logic ="AND" value="-2.0">
				velocities/v-down-fps LT 150.0
				systems/entry_guidance/site-relative-velocity-fps GT -3000.0
			</test>
			<test logic="AND" value="1.0">
				systems/ap/rtls/flyback-trajectory-deviation GT 0.0
				systems/ap/rtls/vspeed-biased-fps GT 0.0
			</test>
			<test logic="AND" value="-1.0">
				systems/ap/rtls/flyback-trajectory-deviation LT 0.0
				systems/ap/rtls/vspeed-biased-fps LT 0.0
			</test>
		</switch>

		<fcs_function name="systems/ap/rtls/flyback-pitch-target">
		<function>
			<min>
			<sum>
				<table>
        			<independentVar lookup="row">propulsion/tank/pct-full</independentVar>
        			<tableData>
					5.0	30.0
					9.3	36.6
					13.3	40.5
					18.3	47.0
					22.8	50.3
					32.0	51.5
					40.6	55.0
					50.0	60.0
        			</tableData>
      				</table>
			
				<min>
				<max>
					<product>
						<difference>
							<value>275000.0</value>
							<property>/position/altitude-ft</property>
						</difference>
						<value>0.001</value>
					</product>
				<value>0.0</value>
				</max>
				<value>10.0</value>
				</min>

				<product>
					<property>systems/ap/rtls/flyback-trajectory-deviation</property>
					<value>0.00035</value>
				</product>

				<product>
					<property>systems/ap/rtls/vspeed-deadband</property>
					<value>0.015</value>
				</product>

				<product>
					<property>systems/ap/rtls/flyback-trajectory-damper</property>
					<value>5.0</value>
				</product>

				<product>
					<max>
					<difference>
						<property>aero/qbar-psf</property>
						<value>1.0</value>
					</difference>
					<value>0.0</value>
					</max>
					<value>10.0</value>
				</product>	

			</sum>
			<value>80.0</value>
			</min>
		</function>
		</fcs_function>



		<fcs_function name="systems/ap/rtls/flyback-pitch-error">
		<function>
			<difference>
				<property>systems/ap/rtls/flyback-pitch-target</property>
				<property>/orientation/pitch-deg</property>
			</difference>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/rtls/powered-pitcharound-pitch-error">
		<function>
			<sum>
				<difference>
					<value>69.0</value>
					<property>/orientation/pitch-deg</property>
				</difference>
				<product>
				<max>
				<min>
					<difference>
						<property>systems/ap/rtls/roll-deg-abs</property>
						<value>90.0</value>
					</difference>
					<value>1.0</value>
				</min>
				<value>0.0</value>
				</max>
				<value>-100.0</value>
			</product>
			</sum>
		</function>
		</fcs_function>
		

		<switch name="systems/ap/rtls/pitch-error">
			<default value="0.0"/>
			<test value="systems/ap/rtls/flyout-pitch-error">
				systems/ap/rtls/flyout-active == 1
			</test>
			<test value="systems/ap/rtls/powered-pitcharound-pitch-error">
				systems/ap/rtls/powered-pitcharound-active == 1
			</test>
			<test value="systems/ap/rtls/flyback-pitch-error">
				systems/ap/rtls/flyback-active == 1
			</test>
			<test value="systems/ap/rtls/powered-pitchdown-pitch-error">
				systems/ap/rtls/powered-pitchdown-active == 1
			</test>
		</switch>

		<switch name="systems/ap/rtls/pitch-gain">
			<default value="0.0"/>
			<test value="0.2">
				systems/ap/rtls/flyout-active == 1
			</test>
			<test  value="0.1">
				systems/ap/rtls/flyback-active == 1
			</test>
			<test value="0.2">
				systems/ap/rtls/powered-pitcharound-active == 1
				systems/ap/rtls/roll-deg-abs LT 90.0
				/orientation/pitch-deg LT 70.0
			</test>
			<test value="0.4">
				systems/ap/rtls/powered-pitcharound-active == 1
				systems/ap/rtls/roll-deg-abs LT 90.0
				/orientation/pitch-deg LT 80.0
			</test>
			<test value="0.7">
				systems/ap/rtls/powered-pitcharound-active == 1
			</test>
			<test value="0.6">
				systems/ap/rtls/powered-pitchdown-active == 1
			</test>

		</switch>

		<fcs_function name="systems/ap/rtls/pitch-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/rtls/pitch-error</property>
						<value>-0.1</value>
					</product>
					<product>
						<property>systems/ap/rtls/pitch-gain</property>
						<value>-1.0</value>
					</product>
				</max>
				<property>systems/ap/rtls/pitch-gain</property>
			</min>
		</function>
		</fcs_function>


	</channel>

	<channel name="Auto GRTLS management" execute="systems/ap/auto-grtls-active">

	<!-- GRTLS has no yaw channel since Aerojet DAP uses yaw to force beta = 0 -->

	
		<!-- phase -->

		<switch name="systems/ap/grtls/alpha-recovery-active">
			<default value="1.0"/>
			<test logic="OR" value="0.0">
				systems/ap/grtls/Nz-hold-active == 1
				systems/ap/grtls/alpha-transition-active == 1
			</test>
		</switch>

		<switch name="systems/ap/grtls/Nz-hold-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/grtls/alpha-recovery-active == 1
				systems/ap/grtls/alpha-transition-active == 0
				accelerations/Nz GT 1.6
			</test>
			<test logic="AND" value="1.0">
				systems/ap/grtls/Nz-hold-active == 1
				systems/ap/grtls/alpha-transition-active == 0
			</test>
		</switch>

		<switch name="systems/ap/grtls/alpha-transition-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/grtls/Nz-hold-active == 1
				velocities/v-down-fps LT -320.0
			</test>
			<test value="1.0">
				systems/ap/grtls/alpha-transition-active == 1
			</test>
		</switch>


		<!-- roll -->

		<fcs_function name="systems/ap/grtls/roll-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>/orientation/roll-deg</property>
						<value>-0.5</value>
					</product>
					<value>-1.0</value>
				</max>
				<value>1.0</value>
			</min>
		</function>
		</fcs_function>


		<!-- pitch -->

		<fcs_function name="systems/ap/grtls/alpha-recovery-pitch-error">
		<function>
			<difference>
				<value>50.0</value>
				<property>aero/alpha-deg</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/grtls/Nz-hold-pitch-error">
		<function>
			<min>
			<product>
				<difference>
					<value>2.1</value>
					<property>accelerations/Nz</property>
				</difference>
				<value>2.0</value>
			</product>
			<value>1.0</value>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/grtls/alpha-transition-pitch-error">
		<function>
			<difference>
				<table>
        				<independentVar lookup="row">velocities/mach</independentVar>
         				<tableData>
           				1.5	9.0
					2.0	12.0
					2.5	14.0
					3.0	16.0
					4.0	19.0
					5.0	23.0
         				</tableData>
      				</table>
				<property>aero/alpha-deg</property>
			</difference>
		</function>
		</fcs_function>


		<switch name="systems/ap/grtls/pitch-error">
			<default value="0.0"/>
			<test value="systems/ap/grtls/alpha-recovery-pitch-error">
				systems/ap/grtls/alpha-recovery-active == 1
			</test>
			<test value="systems/ap/grtls/Nz-hold-pitch-error">
				systems/ap/grtls/Nz-hold-active == 1
			</test>
			<test value="systems/ap/grtls/alpha-transition-pitch-error">
				systems/ap/grtls/alpha-transition-active == 1
			</test>
		</switch>

		<switch name="systems/ap/grtls/pitch-gain">
			<default value="1.0"/>
			<test value="0.4">
				aero/qbar-psf GT 40.0 
			</test>
		</switch>

		<fcs_function name="systems/ap/grtls/pitch-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/grtls/pitch-error</property>
						<value>-0.1</value>
					</product>
					<product>
						<property>systems/ap/grtls/pitch-gain</property>
						<value>-1.0</value>
					</product>
				</max>
				<property>systems/ap/grtls/pitch-gain</property>
			</min>
		</function>
		</fcs_function>

	</channel>



	<!-- auto-launch - due to the very different demands, this is organized in stages -->
	<!-- and the relevant guidance targets are fed by a Nasal script -->

	<channel name="Auto launch management">

		<switch name="systems/ap/launch/stage1-active">
			<default value="0.0"/>
			<test value="1.0">
				systems/ap/launch/stage == 1
			</test>
		</switch>

		<switch name="systems/ap/launch/stage2-active">
			<default value="0.0"/>
			<test value="1.0">
				systems/ap/launch/stage == 2
			</test>
		</switch>

		<switch name="systems/ap/launch/stage3-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/launch/stage == 3
				systems/entry_guidance/guidance-mode == 0
			</test>
		</switch>

		<switch name="systems/ap/launch/stage3-TAL-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/launch/stage == 3
				systems/entry_guidance/guidance-mode == 2
			</test>
		</switch>

		<switch name="systems/ap/launch/stage4-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/launch/stage == 4
				systems/entry_guidance/guidance-mode == 0
			</test>
		</switch>

		<switch name="systems/ap/launch/stage4-TAL-active">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/launch/stage == 4
				systems/entry_guidance/guidance-mode == 2
			</test>
		</switch>

		<switch name="systems/ap/launch/autolaunch-roll-yaw-channel">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/automatic-roll-control == 1
				systems/ap/launch/autolaunch-master == 1
			</test>
		</switch>

		<switch name="systems/ap/launch/autolaunch-pitch-channel">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/ap/automatic-pitch-control == 1
				systems/ap/launch/autolaunch-master == 1
			</test>
		</switch>


		

	</channel>




	<!-- liftoff and rotation to launch course -->
	
	<channel name="Auto launch stage 1" execute="systems/ap/launch/stage1-active">

		<fcs_function name="systems/ap/launch/stage1-course-error">
		<function>
			<sum>
				<product>
					<property>systems/pointing/lvlh/body-y[0]</property>
					<property>systems/ap/launch/course-vector[0]</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-y[1]</property>
					<property>systems/ap/launch/course-vector[1]</property>
				</product>
				<product>
					<property>systems/pointing/lvlh/body-y[2]</property>
					<property>systems/ap/launch/course-vector[2]</property>
				</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage1-roll-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage1-course-error</property>
						<value>-2.0</value>
					</product>
					<value>-0.8</value>
				</max>
				<value>0.8</value>
			</min>
		</function>
		</fcs_function>

	</channel>

	<!-- climbout to SRB separation -->

	<channel name="Auto launch stage 2" execute="systems/ap/launch/stage2-active">

		<fcs_function name="systems/ap/launch/stage2-pitch-error">
		<function>
			<difference>
				<property>/orientation/pitch-deg</property>
				<property>/fdm/jsbsim/systems/ap/launch/pitch-target</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage2-yaw-error">
		<function>
			<product>
			<difference>
				<property>/orientation/heading-deg</property>
				<property>/fdm/jsbsim/systems/ap/launch/launch-azimuth</property>
			</difference>
			<table>
        			<independentVar lookup="row">/orientation/pitch-deg</independentVar>
         			<tableData>
      					0.00	1.0
					80.0	1.0
					85.0	0.0	
       				</tableData>
    			</table>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage2-roll-alt">
		<function>
			<sum>
				<value>360.0</value>
				<property>/orientation/roll-deg</property>
			</sum>
		</function>
		</fcs_function>

		
		<switch name="systems/ap/launch/stage2-roll-deg">
			<default value="/orientation/roll-deg"/>
			<test value="systems/ap/launch/stage2-roll-alt">
				/orientation/roll-deg LT 0.0
			</test>	
		</switch>


		<fcs_function name="systems/ap/launch/stage2-roll-error">
		<function>
			<product>
			<difference>
				<property>systems/ap/launch/stage2-roll-deg</property>
				<value>180.0</value>
			</difference>
			<table>
        			<independentVar lookup="row">/orientation/pitch-deg</independentVar>
         			<tableData>
      					0.00	1.0
					80.0	1.0
					85.0	0.0	
       				</tableData>
    			</table>
			</product>
		</function>
		</fcs_function>




		<fcs_function name="systems/ap/launch/stage2-pitch-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage2-pitch-error</property>
						<value>-0.1</value>
					</product>
					<product>
					<property>systems/ap/launch/pitch-max-rate-norm</property>	
					<value>-1</value>
					</product>
				</max>
				<property>systems/ap/launch/pitch-max-rate-norm</property>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage2-yaw-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage2-yaw-error</property>
						<value>-0.1</value>
					</product>
					<product>	
					<value>-0.1</value>
					</product>
				</max>
				<value>0.1</value>
			</min>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage2-roll-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage2-roll-error</property>
						<value>-0.5</value>
					</product>
					<value>-0.2</value>
				</max>
				<value>0.2</value>
			</min>
		</function>
		</fcs_function>

	</channel>

	<!-- pitchdown, hdot capture and inclination acquisition -->

	<channel name="Auto launch stage 3" execute="systems/ap/launch/stage3-active">

		<fcs_function name="systems/ap/launch/stage3-pitch-error">
		<function>
			<difference>
				<property>/orientation/pitch-deg</property>
				<property>/fdm/jsbsim/systems/ap/launch/pitch-target</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage3-roll-alt">
		<function>
			<sum>
				<value>360.0</value>
				<property>/orientation/roll-deg</property>
			</sum>
		</function>
		</fcs_function>

		
		<switch name="systems/ap/launch/stage3-roll-deg">
			<default value="/orientation/roll-deg"/>
			<test value="systems/ap/launch/stage3-roll-alt">
				/orientation/roll-deg LT 0.0
			</test>	
		</switch>


		<fcs_function name="systems/ap/launch/stage3-roll-error">
		<function>
			<difference>
				<property>systems/ap/launch/stage3-roll-deg</property>
				<value>180.0</value>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage3-inclination-error">
		<function>
			<difference>
				<property>systems/ap/launch/inclination-target</property>
				<property>systems/orbital/inclination-deg</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage3-beta-target">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage3-inclination-error</property>
						<property>systems/ap/launch/inc-acquire-sign</property>
      						<table>
        					<independentVar lookup="row">velocities/mach</independentVar>
         					<tableData>
      						  7.0	0.0
						  8.0	100.0
						  14.0	300.0
						  25.0	100.0
       					  	</tableData>
    						</table>
						<value>0.0</value>
					</product>
					<value>-10.0</value>	
				</max>
				<value>10.0</value>
			</min>
		</function>
		</fcs_function>

  		<deadband name="systems/ap/launch/stage3-beta-PID-trigger">
			<input>systems/ap/launch/stage3-beta-target</input>
			<width>0.3</width>
  		</deadband>

		<pid name="systems/ap/launch/stage3-beta-pid">
			<input>systems/ap/launch/stage3-beta-target</input>
			<kp> 0.7 </kp>
			<ki> 0.2 </ki>
			<kd> 0.3</kd>
			<trigger>systems/ap/launch/stage3-beta-PID-trigger</trigger>
			<clipto>
				<min> -10.0 </min>
        			<max>  10.0 </max>
			</clipto>
		</pid>


		<fcs_function name="systems/ap/launch/stage3-yaw-error">
		<function>
			<difference>
				<property>systems/ap/launch/stage3-beta-pid</property>
				<property>aero/beta-deg</property>
			</difference>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage3-pitch-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage3-pitch-error</property>
						<value>-0.1</value>
					</product>
					<product>
					<property>systems/ap/launch/pitch-max-rate-norm</property>	
					<value>-1</value>
					</product>
				</max>
				<property>systems/ap/launch/pitch-max-rate-norm</property>
			</min>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage3-roll-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage3-roll-error</property>
						<value>-0.5</value>
					</product>
					<value>-0.2</value>
				</max>
				<value>0.2</value>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage3-yaw-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage3-yaw-error</property>
						<value>0.1</value>
					</product>
					<value>-0.2</value>
				</max>
				<value>0.2</value>
			</min>
		</function>
		</fcs_function>

	</channel>

	<!-- hdot management -->

	<channel name="Auto launch stage 4" execute="systems/ap/launch/stage4-active">

		<fcs_function name="systems/ap/launch/stage4-roll-alt">
		<function>
			<sum>
				<value>360.0</value>
				<property>/orientation/roll-deg</property>
			</sum>
		</function>
		</fcs_function>

		
		<switch name="systems/ap/launch/stage4-roll-deg">
			<default value="/orientation/roll-deg"/>
			<test value="systems/ap/launch/stage4-roll-alt">
				/orientation/roll-deg LT 0.0
			</test>	
		</switch>


		<fcs_function name="systems/ap/launch/stage4-roll-error">
		<function>
			<difference>
				<property>systems/ap/launch/stage4-roll-deg</property>
				<value>180.0</value>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage4-inclination-error">
		<function>
			<difference>
				<property>systems/ap/launch/inclination-target</property>
				<property>systems/orbital/inclination-deg</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage4-beta-target">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage4-inclination-error</property>
						<property>systems/ap/launch/inc-acquire-sign</property>
      						<table>
        					<independentVar lookup="row">velocities/mach</independentVar>
         					<!--<tableData>
      						  6.0	0.0
						  7.0	100.0
						  14.0	300.0
						  25.0	100.0
       					  	</tableData>-->
						<tableData>
						  17.0	0.0
						  18.0  200.0
						  25.0	200.0
       					  	</tableData>
    						</table>
					</product>
					<value>-10.0</value>
				</max>
				<value>10.0</value>
			</min>
		</function>
		</fcs_function>

 		<deadband name="systems/ap/launch/stage4-beta-PID-trigger">
			<input>systems/ap/launch/stage4-beta-target</input>
			<width>0.1</width>
  		</deadband>

		<pid name="systems/ap/launch/stage4-beta-pid">
			<input>systems/ap/launch/stage4-beta-target</input>
			<kp> 0.7 </kp>
			<ki> 0.0 </ki>
			<kd> 0.0</kd>
			<!--<ki> 0.2 </ki>
			<kd> 0.3</kd>-->
			<trigger>systems/ap/launch/stage4-beta-PID-trigger</trigger>
			<clipto>
				<min> -4.0 </min>
        			<max>  4.0 </max>
			</clipto>
		</pid>

		<fcs_function name="systems/ap/launch/stage4-yaw-error">
		<function>
			<difference>
				<property>systems/ap/launch/stage4-beta-pid</property>
				<property>aero/beta-deg</property>
			</difference>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage4-hdot-error">
		<function>
			<difference>
				<property>velocities/v-down-fps</property>
				<property>systems/ap/launch/hdot-target</property>
			</difference>
		</function>
		</fcs_function>

  		<deadband name="systems/ap/launch/stage4-pitch-PID-trigger">
			<input>systems/ap/launch/stage4-hdot-error</input>
			<width>30.0</width>
  		</deadband>

		<pid name="systems/ap/launch/stage4-pitch-target">
			<input>systems/ap/launch/stage4-hdot-error</input>
			<kp> 0.3 </kp>
			<ki> 0.05 </ki>
			<kd> 0.1</kd>
			<trigger>systems/ap/launch/stage4-pitch-PID-trigger</trigger>
			<clipto>
				<min> -25.0 </min>
        			<max>  20.0 </max>
			</clipto>
		</pid>


		<fcs_function name="systems/ap/launch/stage4-pitch-error">
		<function>
			<difference>
				<property>/orientation/pitch-deg</property>
				<property>/fdm/jsbsim/systems/ap/launch/stage4-pitch-target</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage4-roll-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage4-roll-error</property>
						<value>-0.5</value>
					</product>
					<value>-0.2</value>
				</max>
				<value>0.2</value>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage4-yaw-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage4-yaw-error</property>
						<value>0.1</value>
					</product>
					<value>-0.25</value>
				</max>
				<value>0.25</value>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage4-pitch-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage4-pitch-error</property>
						<value>-0.1</value>
					</product>
					<product>
						<property>systems/ap/launch/pitch-max-rate-norm</property>	
						<value>-1</value>
					</product>
				</max>
				<property>systems/ap/launch/pitch-max-rate-norm</property>
			</min>
		</function>
		</fcs_function>



	</channel>


	<!-- TAL hdot capture and course acquisition -->

	<channel name="Auto launch stage 3 TAL" execute="systems/ap/launch/stage3-TAL-active">

		<fcs_function name="systems/ap/launch/stage3-TAL-pitch-error">
		<function>
			<difference>
				<property>/orientation/pitch-deg</property>
				<property>/fdm/jsbsim/systems/ap/launch/pitch-target</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage3-TAL-roll-alt">
		<function>
			<sum>
				<value>360.0</value>
				<property>/orientation/roll-deg</property>
			</sum>
		</function>
		</fcs_function>

		
		<switch name="systems/ap/launch/stage3-TAL-roll-deg">
			<default value="/orientation/roll-deg"/>
			<test value="systems/ap/launch/stage3-TAL-roll-alt">
				/orientation/roll-deg LT 0.0
			</test>	
		</switch>


		<fcs_function name="systems/ap/launch/stage3-TAL-roll-error">
		<function>
			<difference>
				<property>systems/ap/launch/stage3-TAL-roll-deg</property>
				<value>180.0</value>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage3-TAL-groundtrack-course-deg-raw">
		<function>
		<product>
			<atan2>
					<property>velocities/v-east-fps</property>
					<property>velocities/v-north-fps</property>
			</atan2>
		<value>57.2957</value>
		</product>
		</function>
		</fcs_function>

		<switch name="systems/ap/launch/stage3-TAL-groundtrack-course-adjust">
			<default value="0.0"/>
			<test  value="360.0">
				systems/ap/launch/stage3-TAL-groundtrack-course-deg-raw LT 0
			</test>
		</switch>
	
		<fcs_function name="systems/ap/launch/stage3-TAL-groundtrack-course-deg">
		<function>
			<sum>
				<property>systems/ap/launch/stage3-TAL-groundtrack-course-adjust</property>
				<property>systems/ap/launch/stage3-TAL-groundtrack-course-deg-raw</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage3-TAL-course-error">
		<function>
			<difference>
				<property>systems/ap/launch/course-target</property>
				<property>systems/ap/launch/stage3-TAL-groundtrack-course-deg</property>
			</difference>
		</function>
		</fcs_function>

		


		<fcs_function name="systems/ap/launch/stage3-TAL-yaw-error">
		<function>
			<difference>
				<sum>
					<property>systems/ap/launch/course-target</property>
					<max>
						<min>
							<property>systems/ap/launch/stage3-TAL-course-error</property>
							<value>10.0</value>
						</min>
					<value>-10.0</value>
					</max>
				</sum>	
				<property>/orientation/heading-deg</property>			
			</difference>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage3-TAL-pitch-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage3-TAL-pitch-error</property>
						<value>-0.1</value>
					</product>
					<product>
					<property>systems/ap/launch/pitch-max-rate-norm</property>	
					<value>-1</value>
					</product>
				</max>
				<property>systems/ap/launch/pitch-max-rate-norm</property>
			</min>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage3-TAL-roll-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage3-TAL-roll-error</property>
						<value>-0.5</value>
					</product>
					<value>-0.2</value>
				</max>
				<value>0.2</value>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage3-TAL-yaw-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage3-TAL-yaw-error</property>
						<value>0.1</value>
					</product>
					<value>-0.2</value>
				</max>
				<value>0.2</value>
			</min>
		</function>
		</fcs_function>

	</channel>


	<channel name="Auto launch stage 4 TAL" execute="systems/ap/launch/stage4-TAL-active">

		<fcs_function name="systems/ap/launch/stage4-TAL-hdot-error">
		<function>
			<difference>
				<property>velocities/v-down-fps</property>
				<property>systems/ap/launch/hdot-target</property>
			</difference>
		</function>
		</fcs_function>

  		<deadband name="systems/ap/launch/stage4-TAL-pitch-PID-trigger">
			<input>systems/ap/launch/stage4-TAL-hdot-error</input>
			<width>30.0</width>
  		</deadband>

		<pid name="systems/ap/launch/stage4-TAL-pitch-target">
			<input>systems/ap/launch/stage4-TAL-hdot-error</input>
			<kp> 0.3 </kp>
			<ki> 0.05 </ki>
			<kd> 0.1</kd>
			<trigger>systems/ap/launch/stage4-TAL-pitch-PID-trigger</trigger>
			<clipto>
				<min> -48.0 </min>
        			<max>  48.0 </max>
			</clipto>
		</pid>


		<fcs_function name="systems/ap/launch/stage4-TAL-pitch-error">
		<function>
			<difference>
				<property>/orientation/pitch-deg</property>
				<property>/fdm/jsbsim/systems/ap/launch/stage4-TAL-pitch-target</property>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage4-TAL-roll-alt">
		<function>
			<sum>
				<value>360.0</value>
				<property>/orientation/roll-deg</property>
			</sum>
		</function>
		</fcs_function>

		
		<switch name="systems/ap/launch/stage4-TAL-roll-deg">
			<default value="/orientation/roll-deg"/>
			<test value="systems/ap/launch/stage4-TAL-roll-alt">
				/orientation/roll-deg LT 0.0
			</test>	
		</switch>


		<fcs_function name="systems/ap/launch/stage4-TAL-roll-error">
		<function>
			<difference>
				<property>systems/ap/launch/stage4-TAL-roll-deg</property>
				<value>180.0</value>
			</difference>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage4-TAL-groundtrack-course-deg-raw">
		<function>
		<product>
			<atan2>
					<property>velocities/v-east-fps</property>
					<property>velocities/v-north-fps</property>
			</atan2>
		<value>57.2957</value>
		</product>
		</function>
		</fcs_function>

		<switch name="systems/ap/launch/stage4-TAL-groundtrack-course-adjust">
			<default value="0.0"/>
			<test  value="360.0">
				systems/ap/launch/stage4-TAL-groundtrack-course-deg-raw LT 0
			</test>
		</switch>
	
		<fcs_function name="systems/ap/launch/stage4-TAL-groundtrack-course-deg">
		<function>
			<sum>
				<property>systems/ap/launch/stage4-TAL-groundtrack-course-adjust</property>
				<property>systems/ap/launch/stage4-TAL-groundtrack-course-deg-raw</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage4-TAL-course-error">
		<function>
			<difference>
				<property>systems/ap/launch/course-target</property>
				<property>systems/ap/launch/stage4-TAL-groundtrack-course-deg</property>
			</difference>
		</function>
		</fcs_function>



		<fcs_function name="systems/ap/launch/stage4-TAL-yaw-error">
		<function>
			<difference>
				<sum>
					<property>systems/ap/launch/course-target</property>
					<max>
						<min>
							<property>systems/ap/launch/stage4-TAL-course-error</property>
							<value>10.0</value>
						</min>
					<value>-10.0</value>
					</max>
				</sum>	
				<property>/orientation/heading-deg</property>			
			</difference>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage4-TAL-pitch-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage4-TAL-pitch-error</property>
						<value>-0.1</value>
					</product>
					<product>
					<property>systems/ap/launch/pitch-max-rate-norm</property>	
					<value>-1</value>
					</product>
				</max>
				<property>systems/ap/launch/pitch-max-rate-norm</property>
			</min>
		</function>
		</fcs_function>


		<fcs_function name="systems/ap/launch/stage4-TAL-roll-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage4-TAL-roll-error</property>
						<value>-0.5</value>
					</product>
					<value>-0.2</value>
				</max>
				<value>0.2</value>
			</min>
		</function>
		</fcs_function>

		<fcs_function name="systems/ap/launch/stage4-TAL-yaw-cmd">
		<function>
			<min>
				<max>
					<product>
						<property>systems/ap/launch/stage4-TAL-yaw-error</property>
						<value>0.1</value>
					</product>
					<value>-0.1</value>
				</max>
				<value>0.1</value>
			</min>
		</function>
		</fcs_function>

	</channel>

	<channel name="Auto launch command merge">

		<switch name="systems/ap/launch/roll-cmd">
			<default value="0.0"/>
			<test value="systems/ap/launch/stage1-roll-cmd">
				systems/ap/launch/stage == 1
			</test>
			<test value="systems/ap/launch/stage2-roll-cmd">
				systems/ap/launch/stage == 2
			</test>
			<test logic="AND" value="systems/ap/launch/stage3-roll-cmd">
				systems/ap/launch/stage == 3
				systems/entry_guidance/guidance-mode == 0
			</test>
			<test logic="AND" value="systems/ap/launch/stage3-TAL-roll-cmd">
				systems/ap/launch/stage == 3
				systems/entry_guidance/guidance-mode == 2
			</test>
			<test logic="AND" value="systems/ap/launch/stage4-roll-cmd">
				systems/ap/launch/stage == 4
				systems/entry_guidance/guidance-mode == 0
			</test>
			<test logic="AND" value="systems/ap/launch/stage4-TAL-roll-cmd">
				systems/ap/launch/stage == 4
				systems/entry_guidance/guidance-mode == 2
			</test>
			<test logic="AND" value="systems/ap/rtls/roll-cmd">
				systems/entry_guidance/guidance-mode == 3
			</test>	
		</switch>

		<switch name="systems/ap/launch/pitch-cmd">
			<default value="0.0"/>
			<test value="systems/ap/launch/stage2-pitch-cmd">
				systems/ap/launch/stage == 2
			</test>
			<test logic="AND" value="systems/ap/launch/stage3-pitch-cmd">
				systems/ap/launch/stage == 3
				systems/entry_guidance/guidance-mode == 0
			</test>
			<test logic="AND" value="systems/ap/launch/stage3-TAL-pitch-cmd">
				systems/ap/launch/stage == 3
				systems/entry_guidance/guidance-mode == 2
			</test>
			<test logic="AND" value="systems/ap/launch/stage4-pitch-cmd">
				systems/ap/launch/stage == 4
				systems/entry_guidance/guidance-mode == 0
			</test>
			<test logic="AND" value="systems/ap/launch/stage4-TAL-pitch-cmd">
				systems/ap/launch/stage == 4
				systems/entry_guidance/guidance-mode == 2
			</test>
			<test logic="AND" value="systems/ap/rtls/pitch-cmd">
				systems/entry_guidance/guidance-mode == 3
			</test>
		</switch>

		<switch name="systems/ap/launch/yaw-cmd">
			<default value="0.0"/>
			<test value="systems/ap/launch/stage2-yaw-cmd">
				systems/ap/launch/stage == 2
			</test>
			<test logic="AND" value="systems/ap/launch/stage3-yaw-cmd">
				systems/ap/launch/stage == 3
				systems/entry_guidance/guidance-mode == 0
			</test>
			<test logic="AND" value="systems/ap/launch/stage3-TAL-yaw-cmd">
				systems/ap/launch/stage == 3
				systems/entry_guidance/guidance-mode == 2
			</test>
			<test logic="AND" value="systems/ap/launch/stage4-yaw-cmd">
				systems/ap/launch/stage == 4
				systems/entry_guidance/guidance-mode == 0
			</test>
			<test logic="AND" value="systems/ap/launch/stage4-TAL-yaw-cmd">
				systems/ap/launch/stage == 4
				systems/entry_guidance/guidance-mode == 2
			</test>
			<test logic="AND" value="systems/ap/rtls/yaw-cmd">
				systems/entry_guidance/guidance-mode == 3
			</test>
		</switch>


		
	</channel>
</system>
