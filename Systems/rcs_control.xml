<?xml version="1.0"?>

<system>

	<!-- the following modes are implemented: -->

	<!-- 1:  RCS rotation - stick controls thrust -->
	<!-- 2:  RCS translation - stick controls thrust -->
	<!-- 3:  RCS rotation and aero surfaces - should be tail only-->
	<!-- 20: RCS DAP-A - precision attitude hold, stick controls rate -->
	<!-- 21: RCS DAP-B - propellant conserving attitude hold, stick controls rate -->
	<!-- 22: RCS ROT TAIL ONLY - nose thrusters are off, stick controls thrust --> 
	<!-- 23: RCS ROT NOSE ONLY - tail pod thrusters are off, stick controls thrust -->
	<!-- 24: RCS ROT ENTRY - nose thrusters are off, stick controls rate -->
	<!-- 25: RCS DAP-A Vernier - precision attitude hold using verniers, stick controls rate -->
	<!-- 26: RCS TRANS ATT-HLD - translational mode commanding attitude hold -->
	<!-- 27: RCS TRANS LOW-Z - translational mode minimizing plume impingement for +Z -->
	<!-- 28: RCS TRANS LOW-Z ATT-HLD - translational mode minimizing plume impingement for +Z -->
	<!-- 29: RCS AEROJET - realistic entry mode with attitude hold commanded also for aero surfaces -->
	<!-- 30: RCS DAP-B Vernier -->


	<channel name="RCS usage">

		<switch name="systems/fcs/rcs-active">
			<default value="0.0"/>
			<test logic="OR" value="1.0">
				systems/fcs/control-mode == 1
				systems/fcs/control-mode == 2
				systems/fcs/control-mode == 3
				systems/fcs/control-mode == 11
				systems/fcs/control-mode == 20
				systems/fcs/control-mode == 21
				systems/fcs/control-mode == 22
				systems/fcs/control-mode == 23
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 25
				systems/fcs/control-mode == 26
				systems/fcs/control-mode == 27
				systems/fcs/control-mode == 28
				systems/fcs/control-mode == 29
				systems/fcs/control-mode == 30
				systems/oms/oms-rcs-dump-cmd == 1
				systems/rcs/fwd-dump-cmd == 1
				systems/rcs/aft-dump-cmd == 1
			</test>
		</switch>

		<switch name="systems/fcs/rcs-inactive">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/rcs-active == 0
			</test>
		</switch>

		<switch name="systems/fcs/rcs-translation">
			<default value="0.0"/>
			<test logic="OR" value="1.0">
				systems/fcs/control-mode == 2
				systems/fcs/control-mode == 26
				systems/fcs/control-mode == 27
				systems/fcs/control-mode == 28
			</test>
		</switch>

	</channel>

	<!-- for the RCS pulse mode, each control input between 0 and 0.5 generates a fixed-duration spike -->

	<channel name="Control Input pulse generation">

		<switch name="systems/fcs/rcs-pulse">
			<default value="0.0"/>
			<test logic="AND" value="1.0">
				systems/fcs/control-mode == 1
				systems/fcs/rcs-use-pulse == 1
			</test>
			<test logic="AND" value="1.0">
				systems/fcs/control-mode == 2
				systems/fcs/rcs-use-pulse == 1
			</test>
			<test logic="AND" value="1.0">
				systems/fcs/control-mode == 27
				systems/fcs/rcs-use-pulse == 1
			</test>
		</switch>

		<!-- adjust pulse durations to match SPEC 20 defined DAP properties -->

		<fcs_function name="systems/fcs/elevator-pulse-duration">
		<function>
			<product>
				<quotient>
					<property>systems/ap/rot-pls-degps</property>
					<value>0.21</value>
				</quotient>
			<value>0.1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/fcs/rudder-pulse-duration">
		<function>
			<product>
				<quotient>
					<property>systems/ap/rot-pls-degps</property>
					<value>0.19</value>
				</quotient>
			<value>0.1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/fcs/aileron-pulse-duration">
		<function>
			<product>
				<quotient>
					<property>systems/ap/rot-pls-degps</property>
					<value>0.10</value>
				</quotient>
			<value>0.1</value>
			</product>
		</function>
		</fcs_function>


		<!-- pulse generation for elevator input -->

		<switch name="systems/fcs/elevator-cmd-norm-pulse-init">
			<default value="fcs/elevator-cmd-norm"/>
			<test logic="AND" value="1.0">
				fcs/elevator-cmd-norm GT 0.0
				fcs/elevator-cmd-norm LT 0.5
			</test>
			<test logic="AND" value="-1.0">
				fcs/elevator-cmd-norm LT 0.0
				fcs/elevator-cmd-norm GT -0.5
			</test>
		</switch>

		<switch name="systems/fcs/elevator-pulse-timer-sample-hold">
			<default value="simulation/sim-time-sec"/>
			<test logic="OR" value="systems/fcs/elevator-pulse-timer-sample-hold">
				fcs/elevator-cmd-norm GT 0.04
				fcs/elevator-cmd-norm LT -0.04
			</test>
		</switch>

		<fcs_function name="systems/fcs/elevator-pulse-generator-signal">
		<function>
			<difference>
				<property>simulation/sim-time-sec</property>
				<property>systems/fcs/elevator-pulse-timer-sample-hold</property>
			</difference>
		</function>
		</fcs_function>

		<switch name="systems/fcs/elevator-pulse-generator">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/elevator-pulse-generator-signal GT 0.0
				systems/fcs/elevator-pulse-generator-signal LT systems/fcs/elevator-pulse-duration
			</test>
		</switch>

		<switch name="systems/fcs/elevator-pulse">
			<default value="systems/fcs/rcs-pulse"/>
			<test logic="OR" value="0.0">
				fcs/elevator-cmd-norm GT 0.5
				fcs/elevator-cmd-norm LT -0.5
			</test>
		</switch>
	

		<fcs_function name="systems/fcs/elevator-cmd-norm-pulse">
		<function>
			<sum>
			<product>
				<property>systems/fcs/elevator-pulse</property>
				<property>systems/fcs/elevator-cmd-norm-pulse-init</property>
				<property>systems/fcs/elevator-pulse-generator</property>
			</product>
			<product>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/elevator-pulse</property>
			</difference>
			<property>fcs/elevator-cmd-norm</property>
			</product>
			</sum>
		</function>
		</fcs_function>
	
		<!--  pulse generation for rudder input -->

		<switch name="systems/fcs/rudder-cmd-norm-pulse-init">
			<default value="fcs/rudder-cmd-norm"/>
			<test logic="AND" value="1.0">
				fcs/rudder-cmd-norm GT 0.0
				fcs/rudder-cmd-norm LT 0.5
			</test>
			<test logic="AND" value="-1.0">
				fcs/rudder-cmd-norm LT 0.0
				fcs/rudder-cmd-norm GT -0.5
			</test>
		</switch>

		<switch name="systems/fcs/rudder-pulse-timer-sample-hold">
			<default value="simulation/sim-time-sec"/>
			<test logic="OR" value="systems/fcs/rudder-pulse-timer-sample-hold">
				fcs/rudder-cmd-norm GT 0.04
				fcs/rudder-cmd-norm LT -0.04
			</test>
		</switch>

		<fcs_function name="systems/fcs/rudder-pulse-generator-signal">
		<function>
			<difference>
				<property>simulation/sim-time-sec</property>
				<property>systems/fcs/rudder-pulse-timer-sample-hold</property>
			</difference>
		</function>
		</fcs_function>

		<switch name="systems/fcs/rudder-pulse-generator">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/rudder-pulse-generator-signal GT 0.0
				systems/fcs/rudder-pulse-generator-signal LT systems/fcs/rudder-pulse-duration
			</test>
		</switch>

		<switch name="systems/fcs/rudder-pulse">
			<default value="systems/fcs/rcs-pulse"/>
			<test logic="OR" value="0.0">
				fcs/rudder-cmd-norm GT 0.5
				fcs/rudder-cmd-norm LT -0.5
			</test>
		</switch>
	
		<fcs_function name="systems/fcs/rudder-cmd-norm-pulse">
		<function>
			<sum>
			<product>
				<property>systems/fcs/rudder-pulse</property>
				<property>systems/fcs/rudder-cmd-norm-pulse-init</property>
				<property>systems/fcs/rudder-pulse-generator</property>
			</product>
			<product>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/rudder-pulse</property>
			</difference>
			<property>fcs/rudder-cmd-norm</property>
			</product>
			</sum>
		</function>
		</fcs_function>

		<!-- pulse generation for aileron input -->


		<switch name="systems/fcs/aileron-cmd-norm-pulse-init">
			<default value="fcs/aileron-cmd-norm"/>
			<test logic="AND" value="1.0">
				fcs/aileron-cmd-norm GT 0.0
				fcs/aileron-cmd-norm LT 0.5
			</test>
			<test logic="AND" value="-1.0">
				fcs/aileron-cmd-norm LT 0.0
				fcs/aileron-cmd-norm GT -0.5
			</test>
		</switch>

		<switch name="systems/fcs/aileron-pulse-timer-sample-hold">
			<default value="simulation/sim-time-sec"/>
			<test logic="OR" value="systems/fcs/aileron-pulse-timer-sample-hold">
				fcs/aileron-cmd-norm GT 0.04
				fcs/aileron-cmd-norm LT -0.04
			</test>
		</switch>

		<fcs_function name="systems/fcs/aileron-pulse-generator-signal">
		<function>
			<difference>
				<property>simulation/sim-time-sec</property>
				<property>systems/fcs/aileron-pulse-timer-sample-hold</property>
			</difference>
		</function>
		</fcs_function>

		<switch name="systems/fcs/aileron-pulse-generator">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-pulse-generator-signal GT 0.0
				systems/fcs/aileron-pulse-generator-signal LT systems/fcs/aileron-pulse-duration
			</test>
		</switch>


		<switch name="systems/fcs/aileron-pulse">
			<default value="systems/fcs/rcs-pulse"/>
			<test logic="OR" value="0.0">
				fcs/aileron-cmd-norm GT 0.5
				fcs/aileron-cmd-norm LT -0.5
			</test>
		</switch>

		<fcs_function name="systems/fcs/aileron-cmd-norm-pulse">
		<function>
			<sum>
			<product>
				<property>systems/fcs/aileron-pulse</property>
				<property>systems/fcs/aileron-cmd-norm-pulse-init</property>
				<property>systems/fcs/aileron-pulse-generator</property>
			</product>
			<product>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/aileron-pulse</property>
			</difference>
			<property>fcs/aileron-cmd-norm</property>
			</product>
			</sum>
		</function>
		</fcs_function>
	
	</channel>



	<channel name="Control input sense switching" execute="systems/fcs/rcs-active">

		<fcs_function name="systems/fcs/neg-elevator-cmd-norm">
		<function>
			<product>
				<!--<property>fcs/elevator-cmd-norm</property>-->
				<property>systems/fcs/elevator-cmd-norm-pulse</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/fcs/neg-rudder-cmd-norm">
		<function>
			<product>
				<!--<property>fcs/rudder-cmd-norm</property>-->
				<property>systems/fcs/rudder-cmd-norm-pulse</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/fcs/neg-aileron-cmd-norm">
		<function>
			<product>
				<!--<property>fcs/aileron-cmd-norm</property>-->
				<property>systems/fcs/aileron-cmd-norm-pulse</property>
				<value>-1</value>
			</product>
		</function>
		</fcs_function>
	
		<switch name="systems/fcs/elevator-cmd-norm-sense-base">
			<default value="systems/fcs/elevator-cmd-norm-pulse"/>
			<test logic="AND" value="systems/fcs/neg-elevator-cmd-norm">
				systems/fcs/sense-minus-X == 1
				systems/fcs/rcs-translation == 0
			</test>
			<test logic="AND" value="systems/fcs/neg-elevator-cmd-norm">
				systems/fcs/sense-minus-Z == 1
				systems/fcs/rcs-translation == 0
			</test>
			<test logic="AND" value="systems/fcs/elevator-cmd-norm-pulse">
				systems/fcs/sense-minus-X == 1
				systems/fcs/rcs-translation == 1
			</test>
			<test logic="AND" value="systems/fcs/rudder-cmd-norm-pulse">
				systems/fcs/sense-minus-Z == 1
				systems/fcs/rcs-translation == 1
			</test>
		</switch>

		<switch name="systems/fcs/rudder-cmd-norm-sense-base">
			<default value="systems/fcs/rudder-cmd-norm-pulse"/>
			<test logic="AND" value="systems/fcs/rudder-cmd-norm-pulse">
				systems/fcs/sense-minus-X == 1
				systems/fcs/rcs-translation == 0
			</test>
			<test logic="AND" value="systems/fcs/aileron-cmd-norm-pulse">
				systems/fcs/sense-minus-Z == 1
				systems/fcs/rcs-translation == 0
			</test>
			<test logic="AND" value="systems/fcs/neg-rudder-cmd-norm">
				systems/fcs/sense-minus-X == 1
				systems/fcs/rcs-translation == 1
			</test>
			<test logic="AND" value="systems/fcs/neg-elevator-cmd-norm">
				systems/fcs/sense-minus-Z == 1
				systems/fcs/rcs-translation == 1
			</test>
		</switch>

		<switch name="systems/fcs/aileron-cmd-norm-sense-base">
			<default value="systems/fcs/aileron-cmd-norm-pulse"/>
			<test logic="AND" value="systems/fcs/neg-aileron-cmd-norm">
				systems/fcs/sense-minus-X == 1
				systems/fcs/rcs-translation == 0
			</test>
			<test logic="AND" value="systems/fcs/rudder-cmd-norm-pulse">
				systems/fcs/sense-minus-Z == 1
				systems/fcs/rcs-translation == 0
			</test>
			<test logic="AND" value="systems/fcs/neg-aileron-cmd-norm">
				systems/fcs/sense-minus-X == 1
				systems/fcs/rcs-translation == 1
			</test>
			<test logic="AND" value="systems/fcs/neg-aileron-cmd-norm">
				systems/fcs/sense-minus-Z == 1
				systems/fcs/rcs-translation == 1
			</test>
		</switch>

		<!-- veto the command inputs when THC and RHC control the RMS arm -->
		<!-- this allows to remain in attitude-hold modes while handling payload -->
		<!-- also merge with AP commands -->	

		<!-- AP commands are either AUTO in which case they replace any control -->	
		<!-- or LVLH in which case they are added to controls -->
		<!-- for TRANS ATT HLD we can not add the LVLH controls to the stick input -->
		<!-- because stick input represents translations -->
		<!-- so we merge them later before deadbanding -->

		<fcs_function name="systems/fcs/aileron-cmd-norm-sense">
		<function>
			<sum>
			<product>
				<difference>
					<value>1</value>
					<property>systems/ap/auto-rotation-mode</property>
				</difference>
				<sum>
					<product>
						<property>systems/fcs/aileron-cmd-norm-sense-base</property>
						<property>systems/fcs/rms-control-veto</property>
					</product>
				</sum>				
			</product>
			<product>
				<property>systems/ap/auto-rotation-mode</property>
				<property>systems/ap/roll-rate-controller</property>
			</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/fcs/rudder-cmd-norm-sense">
		<function>
			<sum>
			<product>
				<difference>
					<value>1</value>
					<property>systems/ap/auto-rotation-mode</property>
				</difference>
				<sum>
					<product>
						<property>systems/fcs/rudder-cmd-norm-sense-base</property>
						<property>systems/fcs/rms-control-veto</property>
					</product>
				</sum>
			</product>
			<product>
				<property>systems/ap/auto-rotation-mode</property>
				<property>systems/ap/yaw-rate-controller</property>
			</product>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/fcs/elevator-cmd-norm-sense">
		<function>
			<sum>
			<product>
				<difference>
					<value>1</value>
					<property>systems/ap/auto-rotation-mode</property>
				</difference>
				<sum>
					<product>
						<property>systems/fcs/elevator-cmd-norm-sense-base</property>
						<property>systems/fcs/rms-control-veto</property>
					</product>
				</sum>
			</product>
			<product>
				<property>systems/ap/auto-rotation-mode</property>
				<property>systems/ap/pitch-rate-controller</property>
			</product>
			</sum>
		</function>
		</fcs_function>


	</channel>

	<channel name="DAP modes" execute="systems/fcs/rcs-active">



		<switch name="systems/fcs/rate-control-master">
			<default value="0.0"/>
			<test logic="OR" value="1.0">
				systems/fcs/control-mode == 20
				systems/fcs/control-mode == 21
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 25
				systems/fcs/control-mode == 29
				systems/fcs/control-mode == 30
			</test>
		</switch>

		<!-- the problem to solve is that thrusters shouldn't run forever to minimize errors -->
		<!-- so we stop them at a deadband - but then they take forever to correct in minute -->
		<!-- bursts, so before they reach the deadband, they get a burst enhancement factor -->
		<!-- to kick the state of the orbiter well into the deadband -->
		<!-- this minimizes stationkeeping effort -->

		<!-- we apply the deadband to the normalized control, hence need to normalize -->

		<!-- actual values of the deadbands are defined in autopilot.xml -->
		<!-- based on SPEC 20 utility -->

		<fcs_function name="systems/fcs/rcs-deadband-rotation">
		<function>
			<product>
				<property>systems/ap/rate-db-degps</property>
				<value>0.45</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/fcs/rcs-burst-rotation">
		<function>
			<product>
				<property>systems/fcs/rcs-deadband-rotation</property>
				<value>1.5</value>
			</product>
		</function>
		</fcs_function>



		<switch name="systems/fcs/rcs-entry-mode">
			<default value="0.0"/>
			<test logic="OR" value="1.0">
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 29
			</test>
		</switch>

		<switch name="systems/fcs/rcs-trans-att-hold">
			<default value="0.0"/>
			<test logic="OR" value="1.0">
				systems/fcs/control-mode == 26
				systems/fcs/control-mode == 28
			</test>
		</switch>

		<switch name="systems/fcs/rcs-entry-roll-compensation-veto">
			<default value="1.0"/>
			<test value="0.0">
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 29
			</test>
		</switch>

		<switch name="systems/fcs/rcs-default-thrusters">
			<default value="1.0"/>
			<test logic="OR" value="0.0">
				systems/fcs/control-mode == 25
				systems/fcs/control-mode == 30
			</test>
		</switch>

		<switch name="systems/fcs/rcs-vernier-gain">
			<default value="1.0"/>
			<test logic="OR" value="50.0">
				systems/fcs/control-mode == 25
				systems/fcs/control-mode == 30
			</test>
		</switch>

		<switch name="systems/fcs/rcs-low-z">
			<default value="1.0"/>
			<test logic = "OR" value="0.0">
				systems/fcs/control-mode == 27
				systems/fcs/control-mode == 28
			</test>
		</switch>


		<!-- for error-rate controlled modes, we don't need to fire compensating thrusters -->

		<switch name="systems/fcs/rcs-modemixing-damper">
			<default value="1.0"/>
			<test value="0.0">
				systems/fcs/control-mode == 20
				systems/fcs/control-mode == 21
				systems/fcs/control-mode == 25
				systems/fcs/control-mode == 26
				systems/fcs/control-mode == 28
				systems/fcs/control-mode == 30
			</test>
		</switch>

		<!-- pitch -->

   		<fcs_function name="systems/rcs/elevator-ap-cmd-merge">
   			<function>
			<sum>
				<product>
					<difference>
						<value>1</value>
						<property>systems/ap/alpha-hold-mode</property>
					</difference>
					<property>systems/fcs/elevator-cmd-norm-sense</property>
				</product>
				<product>
					<property>systems/ap/alpha-hold-mode</property>
					<property>systems/ap/alpha-controller-elevator-cmd-norm</property>
				</product>
			</sum>
  		 </function>
   		</fcs_function>

		<fcs_function name="systems/rcs/pitch-rate-error">
		<function>
			<product>
			<difference>
				<property>velocities/q-rad_sec</property>
				<product>
  					<property>systems/rcs/elevator-ap-cmd-merge</property>
					<value>-0.017543</value>
					<property>systems/ap/rot-rate-degps</property>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rcs-trans-att-hold</property>
					</difference>
				</product>
			</difference>
			<property>systems/fcs/rcs-vernier-gain</property>
			</product>
		</function>
		</fcs_function>
		
	
		<pid name="systems/rcs/dap-pitch">
			<input>systems/rcs/pitch-rate-error</input>
			<kp> 15.0 </kp>
			<ki> 0.0 </ki>
			<kd> 0.0</kd>
			<clipto>
				<min> -1.0 </min>
        			<max>  1.0 </max>
			</clipto>
			<output>systems/rcs/dap-pitch-cmd-orbit</output>
		</pid>



		<pid name="systems/rcs/dap-pitch-entry">
			<input>systems/rcs/pitch-rate-error</input>
			<kp> 40.0 </kp>
			<ki> 15.0 </ki>
			<kd> 0.0</kd>
			<clipto>
				<min> -1.0 </min>
        			<max>  1.0 </max>
			</clipto>
			<output>systems/rcs/dap-pitch-cmd-entry</output>
		</pid>

		<fcs_function name="systems/rcs/dap-pitch-cmd">
		<function>
			<sum>
				<product>
					<property>systems/fcs/rcs-entry-mode</property>
					<property>systems/rcs/dap-pitch-cmd-entry</property>
				</product>
				<product>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rcs-entry-mode</property>
					</difference>
					<property>systems/rcs/dap-pitch-cmd-orbit</property>
				</product>
				<property>systems/ap/lvlh/pitch-rate-cmd</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/rcs/dap-pitch-cmd-abs">
		<function>
			<abs>
				<property>systems/rcs/dap-pitch-cmd</property>
			</abs>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/dap-pitch-cmd-burst">
		<function>
			<product>
				<value>25.0</value>
				<property>systems/rcs/dap-pitch-cmd</property>
			</product>
		</function>
		</fcs_function>

		

		<switch name="systems/rcs/dap-pitch-cmd-deadband">
			<default value="systems/rcs/dap-pitch-cmd"/>
			<test value="0.0">
				systems/rcs/dap-pitch-cmd-abs LT systems/fcs/rcs-deadband-rotation
			</test>
			<test value="systems/rcs/dap-pitch-cmd-burst">
				systems/rcs/dap-pitch-cmd-abs LT systems/fcs/rcs-burst-rotation
			</test>
		</switch>

		<!-- roll -->
	
		<fcs_function name="systems/rcs/roll-rate-error">
		<function>
			<product>
			<difference>
				<property>velocities/p-rad_sec</property>
				<product>
  					<property>systems/fcs/aileron-cmd-norm-sense</property>
					<value>0.017543</value>
					<property>systems/ap/rot-rate-degps</property>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rcs-trans-att-hold</property>
					</difference>
				</product>
			</difference>
			<property>systems/fcs/rcs-vernier-gain</property>
			</product>
		</function>
		</fcs_function>

	
		<pid name="systems/rcs/dap-roll">
			<input>systems/rcs/roll-rate-error</input>
			<kp> -25.0 </kp>
			<ki> 0.0 </ki>
			<kd> 0.0</kd>
			<clipto>
				<min> -1.0 </min>
        			<max>  1.0 </max>
			</clipto>
			<!--<output>systems/rcs/dap-roll-cmd</output>-->
		</pid>


		<fcs_function name="systems/rcs/dap-roll-cmd">
		<function>
			<sum>
				<property>systems/rcs/dap-roll</property>
				<property>systems/ap/lvlh/roll-rate-cmd</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/dap-roll-cmd-abs">
		<function>
			<abs>
				<property>systems/rcs/dap-roll-cmd</property>
			</abs>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/dap-roll-cmd-burst">
		<function>
			<product>
				<value>25.0</value>
				<property>systems/rcs/dap-roll-cmd</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/dap-roll-cmd-deadband">
			<default value="systems/rcs/dap-roll-cmd"/>
			<test value="0.0">
				systems/rcs/dap-roll-cmd-abs LT systems/fcs/rcs-deadband-rotation
			</test>
			<test value="systems/rcs/dap-roll-cmd-burst">
				systems/rcs/dap-roll-cmd-abs LT systems/fcs/rcs-burst-rotation
			</test>
		</switch>

		<!-- yaw -->

		<fcs_function name="systems/rcs/yaw-rate-error">
		<function>
			<product>
			<difference>
				<property>velocities/r-rad_sec</property>
				<product>
  					<property>systems/fcs/rudder-cmd-norm-sense</property>
					<value>-0.017543</value>
					<property>systems/ap/rot-rate-degps</property>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rcs-trans-att-hold</property>
					</difference>
				</product>
			</difference>
			<property>systems/fcs/rcs-vernier-gain</property>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/beta-error">
		<function>		
			<product>
				<property>aero/beta-rad</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/yaw-error">
		<function>
			<sum>
				<property>systems/rcs/beta-error</property>
				<property>systems/rcs/yaw-rate-error</property>
			</sum>
		</function>
		</fcs_function>

	
		<pid name="systems/rcs/dap-yaw">
			<input>systems/rcs/yaw-rate-error</input>
			<kp> 15.0 </kp>
			<ki> 0.0 </ki>
			<kd> 0.0</kd>
			<clipto>
				<min> -1.0 </min>
        			<max>  1.0 </max>
			</clipto>
			<output>systems/rcs/dap-yaw-cmd-orbit</output>
		</pid>

		<!-- the RCS yaw jets need to ensure stability during entry against -->
		<!-- the beta-induced yawing moment -->
		<!-- at full thrust a cluster can barely hold against beta = 2 deg at qbar = 400 psf-->
		<!-- so the gains need to be really agressive -->
		<!-- we fire full thrust at 0.25 degrees offset -->

		<pid name="systems/rcs/dap-yaw-entry">
			<input>systems/rcs/beta-error</input>
			<kp> 240.0 </kp>
			<ki> 0.0 </ki>
			<kd> 220.0</kd>
			<clipto>
				<min> -1.0 </min>
        			<max>  1.0 </max>
			</clipto>
			<output>systems/rcs/dap-yaw-cmd-entry-raw</output>
		</pid>

		<fcs_function name="systems/rcs/dap-yaw-cmd-entry">
		<function>
			<min>
			<max>
				<product>
				<table>
        				<independentVar lookup="row">aero/qbar-psf</independentVar>
        				<tableData>
          				 0.0        0.10
	 	  			10.0	    0.50
		   			30.0	    1.00
        				</tableData>
      					</table>
					<property>systems/rcs/dap-yaw-entry</property>
				</product>
			<value>-1.0</value>
			</max>
			<value>1.0</value>
			</min>
		</function>
		</fcs_function>

		<!--<fcs_function name="systems/rcs/dap-yaw-cmd-entry">
		<function>
			<product>
				<property>systems/rcs/dap-yaw-cmd-entry-raw</property>
				<min>
				<max>
				<quotient>
					<property>aero/qbar-psf</property>
					<value>20.0</value>
				</quotient>
				<value>0.1</value>
				</max>
				<value>1.0</value>
				</min>
			</product>
		</function>
		</fcs_function>-->

		<fcs_function name="systems/rcs/dap-yaw-cmd">
		<function>
			<sum>
				<product>
					<property>systems/fcs/rcs-entry-mode</property>
					<property>systems/rcs/dap-yaw-cmd-entry</property>
				</product>
				<product>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rcs-entry-mode</property>
					</difference>
					<property>systems/rcs/dap-yaw-cmd-orbit</property>
				</product>
				<property>systems/ap/lvlh/yaw-rate-cmd</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/dap-yaw-cmd-abs">
		<function>
			<abs>
				<property>systems/rcs/dap-yaw-cmd</property>
			</abs>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/dap-yaw-cmd-burst">
		<function>
			<product>
				<value>25.0</value>
				<property>systems/rcs/dap-yaw-cmd</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/dap-yaw-cmd-deadband">
			<default value="systems/rcs/dap-yaw-cmd"/>
			<test value="0.0">
				systems/rcs/dap-yaw-cmd-abs LT systems/fcs/rcs-deadband-rotation
			</test>
			<test value="systems/rcs/dap-yaw-cmd-burst">
				systems/rcs/dap-yaw-cmd-abs LT systems/fcs/rcs-burst-rotation
			</test>
		</switch>


	</channel>


	<channel name="RCS controls" execute="systems/fcs/rcs-active">

		

		<switch name="systems/fcs/rcs-thrust-factor-rotation">
			<default value="0.0"/>
			<test logic="OR" value="1.0">
				systems/fcs/control-mode == 1
				systems/fcs/control-mode == 3
				systems/fcs/control-mode == 20
				systems/fcs/control-mode == 21
				systems/fcs/control-mode == 22
				systems/fcs/control-mode == 23
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 25
				systems/fcs/control-mode == 26
				systems/fcs/control-mode == 28
				systems/fcs/control-mode == 29
				systems/fcs/control-mode == 30
			</test>
		</switch>

		<switch name="systems/fcs/rcs-thrust-factor-translation">
			<default value="0.0"/>
			<test logic="OR" value="1.0">
				systems/fcs/control-mode == 2
				systems/fcs/control-mode == 26
				systems/fcs/control-mode == 27
				systems/fcs/control-mode == 28
			</test>
		</switch>

		<switch name="systems/fcs/rcs-nose-active">
			<default value="1.0"/>
			<test logic="OR" value="0.0">
				systems/fcs/control-mode == 22
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 29
			</test>
		</switch>

		<switch name="systems/fcs/rcs-nose-active-pitch">
			<default value="1.0"/>
			<test logic="OR" value="0.0">
				systems/fcs/control-mode == 22
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 29
			</test>
			<test logic="AND" value="0.0">
				systems/fcs/control-mode == 20
				systems/ap/spec20/dap-A-PRI-p-opt == 1
			</test>
			<test logic="AND" value="0.0">
				systems/fcs/control-mode == 21
				systems/ap/spec20/dap-B-PRI-p-opt == 1
			</test>
		</switch>

		<switch name="systems/fcs/rcs-nose-active-yaw">
			<default value="1.0"/>
			<test logic="OR" value="0.0">
				systems/fcs/control-mode == 22
				systems/fcs/control-mode == 24
				systems/fcs/control-mode == 29
			</test>
			<test logic="AND" value="0.0">
				systems/fcs/control-mode == 20
				systems/ap/spec20/dap-A-PRI-y-opt == 1
			</test>
			<test logic="AND" value="0.0">
				systems/fcs/control-mode == 21
				systems/ap/spec20/dap-B-PRI-y-opt == 1
			</test>
		</switch>

		<switch name="systems/fcs/rcs-tail-active">
			<default value="1.0"/>
			<test value="0.0">
				systems/fcs/control-mode == 23
			</test>
		</switch>

		<switch name="systems/fcs/rcs-tail-active-pitch">
			<default value="1.0"/>
			<test value="0.0">
				systems/fcs/control-mode == 23
			</test>
			<test logic="AND" value="0.0">
				systems/fcs/control-mode == 20
				systems/ap/spec20/dap-A-PRI-p-opt == 2
			</test>
			<test logic="AND" value="0.0">
				systems/fcs/control-mode == 21
				systems/ap/spec20/dap-B-PRI-p-opt == 2
			</test>
		</switch>

		<switch name="systems/fcs/rcs-tail-active-yaw">
			<default value="1.0"/>
			<test value="0.0">
				systems/fcs/control-mode == 23
			</test>
			<test logic="AND" value="0.0">
				systems/fcs/control-mode == 20
				systems/ap/spec20/dap-A-PRI-y-opt == 2
			</test>
			<test logic="AND" value="0.0">
				systems/fcs/control-mode == 21
				systems/ap/spec20/dap-B-PRI-y-opt == 2
			</test>
		</switch>
	



	<!-- we pre-filter the commands to get more sensitive response at low thrust -->


		<fcs_function name="systems/rcs/aileron-cmd-norm-filtered">
			<function>
				<sum>
				<product>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rate-control-master</property>
					</difference>
					<property>systems/fcs/aileron-cmd-norm-sense</property>
				<abs>
					<property>systems/fcs/aileron-cmd-norm-sense</property>
				</abs>
				</product>
				<product>
					<property>systems/fcs/rate-control-master</property>
					<property>systems/rcs/dap-roll-cmd-deadband</property>
				</product>
				</sum>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/aileron-att-cmd-norm-filtered">
			<function>
				<product>
					<property>systems/fcs/rcs-trans-att-hold</property>
					<property>systems/rcs/dap-roll-cmd-deadband</property>
				</product>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/elevator-cmd-norm-filtered">
			<function>
				<sum>
				<product>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rate-control-master</property>
					</difference>
					<property>systems/fcs/elevator-cmd-norm-sense</property>
					<abs>
						<property>systems/fcs/elevator-cmd-norm-sense</property>
					</abs>
				</product>
				<product>
					<property>systems/fcs/rate-control-master</property>
					<property>systems/rcs/dap-pitch-cmd-deadband</property>
				</product>
				<!--<product>
					<property>systems/fcs/rcs-trans-att-hold</property>
					<property>systems/rcs/dap-pitch-cmd-deadband</property>
				</product>-->
				</sum>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/elevator-att-cmd-norm-filtered">
			<function>
				<product>
					<property>systems/fcs/rcs-trans-att-hold</property>
					<property>systems/rcs/dap-pitch-cmd-deadband</property>
				</product>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/rudder-cmd-norm-filtered">
			<function>
				<sum>
				<product>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rate-control-master</property>
					</difference>
					<property>systems/fcs/rudder-cmd-norm-sense</property>
				<abs>
					<property>systems/fcs/rudder-cmd-norm-sense</property>
				</abs>
				</product>
				<product>
					<property>systems/fcs/rate-control-master</property>
					<property>systems/rcs/dap-yaw-cmd-deadband</property>
				</product>
				<!--<product>
					<property>systems/fcs/rcs-trans-att-hold</property>
					<property>systems/rcs/dap-yaw-cmd-deadband</property>
				</product>-->
				</sum>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/rudder-att-cmd-norm-filtered">
			<function>
				<product>
					<property>systems/fcs/rcs-trans-att-hold</property>
					<property>systems/rcs/dap-yaw-cmd-deadband</property>
				</product>
			</function>
		</fcs_function>

	<!-- we may have 'attitude hold' commanded for translational modes, in which case -->
	<!-- airfoil command norms do not contain the proper rotation commands -->

		<fcs_function name="systems/rcs/aileron-rot-cmd-norm-filtered">
			<function>
				<sum>
				<product>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rcs-trans-att-hold</property>
					</difference>
					<property>systems/rcs/aileron-cmd-norm-filtered</property>
				</product>
				<property>systems/rcs/aileron-att-cmd-norm-filtered</property>
				</sum>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/elevator-rot-cmd-norm-filtered">
			<function>
				<sum>
				<product>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rcs-trans-att-hold</property>
					</difference>
					<property>systems/rcs/elevator-cmd-norm-filtered</property>
				</product>
				<property>systems/rcs/elevator-att-cmd-norm-filtered</property>
				</sum>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/rudder-rot-cmd-norm-filtered">
			<function>
				<sum>
				<product>
					<difference>
						<value>1.0</value>
						<property>systems/fcs/rcs-trans-att-hold</property>
					</difference>
					<property>systems/rcs/rudder-cmd-norm-filtered</property>
				</product>
				<property>systems/rcs/rudder-att-cmd-norm-filtered</property>
				</sum>
			</function>
		</fcs_function>


	<!-- roll thrust patterns -->

		<switch name="systems/rcs/pod1-up-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-up-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod1-up-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-down-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-down-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod1-down-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-up-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-up-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod2-up-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-down-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-down-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod2-down-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-right-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered LT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/nose-right-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-right-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<property>systems/fcs/rcs-tail-active</property>
				<value>-0.35</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-left-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered GT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/nose-left-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-left-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<property>systems/fcs/rcs-tail-active</property>
				<value>0.35</value>
			</product>
		</function>
		</fcs_function>
		
		<!-- roll for nose only needs to fire the up/down thrusters individually -->


		<switch name="systems/rcs/nose-leftdown-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-leftdown-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-leftdown-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
				<difference>
					<value>1.0</value>
					<product>
						<property>systems/fcs/rcs-tail-active</property>
						<property>systems/fcs/rcs-tail-active-pitch</property>
					</product>
				</difference>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-rightup-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-rightup-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-rightup-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
				<difference>
					<value>1.0</value>
					<product>
						<property>systems/fcs/rcs-tail-active</property>
						<property>systems/fcs/rcs-tail-active-pitch</property>
					</product>
				</difference>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-rightdown-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-rightdown-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-rightdown-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
				<difference>
					<value>1.0</value>
					<product>
						<property>systems/fcs/rcs-tail-active</property>
						<property>systems/fcs/rcs-tail-active-pitch</property>
					</product>
				</difference>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-leftup-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/aileron-rot-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-leftup-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-roll-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-leftup-fire-roll</property>
				<property>systems/rcs/aileron-rot-cmd-norm-filtered</property>
				<difference>
					<value>1.0</value>
					<product>
						<property>systems/fcs/rcs-tail-active</property>
						<property>systems/fcs/rcs-tail-active-pitch</property>
					</product>
				</difference>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>
		

	<!-- pitch thrust patterns -->

		<switch name="systems/rcs/nose-up-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/elevator-rot-cmd-norm-filtered GT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/nose-up-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-pitch-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-up-fire-pitch</property>
				<property>systems/rcs/elevator-rot-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-down-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/elevator-rot-cmd-norm-filtered LT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/nose-down-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-pitch-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-down-fire-pitch</property>
				<property>systems/rcs/elevator-rot-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/rcs/pod1-up-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/elevator-rot-cmd-norm-filtered LT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/pod1-up-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-pitch-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod1-up-fire-pitch</property>
				<property>systems/rcs/elevator-rot-cmd-norm-filtered</property>
				<value>-0.5</value>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/rcs/pod2-up-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/elevator-rot-cmd-norm-filtered LT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/pod2-up-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-pitch-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod2-up-fire-pitch</property>
				<property>systems/rcs/elevator-rot-cmd-norm-filtered</property>
				<value>-0.5</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-down-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/elevator-rot-cmd-norm-filtered GT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/pod1-down-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-pitch-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod1-down-fire-pitch</property>
				<property>systems/rcs/elevator-rot-cmd-norm-filtered</property>
				<value>0.5</value>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/rcs/pod2-down-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/elevator-rot-cmd-norm-filtered GT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/pod2-down-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-pitch-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod2-down-fire-pitch</property>
				<property>systems/rcs/elevator-rot-cmd-norm-filtered</property>
				<value>0.5</value>
			</product>
		</function>
		</fcs_function>

	<!-- yaw thrust patterns -->

		<switch name="systems/rcs/nose-left-fire-yaw">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-rot-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-left-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-yaw-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-left-fire-yaw</property>
				<property>systems/rcs/rudder-rot-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-right-fire-yaw">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-rot-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-right-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-yaw-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/nose-right-fire-yaw</property>
				<property>systems/rcs/rudder-rot-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-left-fire-yaw">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-rot-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-left-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-yaw-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod1-left-fire-yaw</property>
				<property>systems/rcs/rudder-rot-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-right-fire-yaw">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-rot-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-right-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-yaw-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod2-right-fire-yaw</property>
				<property>systems/rcs/rudder-rot-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<!-- since pod thrusters are higher than nose, firing yaw causes a roll moment-->
		<!-- which needs to be compensated -->

		<switch name="systems/rcs/pod1-up-fire-yaw">
		<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-rot-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-up-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-yaw-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod1-up-fire-yaw</property>
				<property>systems/rcs/rudder-rot-cmd-norm-filtered</property>
				<property>systems/fcs/rcs-entry-roll-compensation-veto</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<value>0.55</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-down-fire-yaw">
		<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-rot-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-down-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-yaw-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod2-down-fire-yaw</property>
				<property>systems/rcs/rudder-rot-cmd-norm-filtered</property>
				<property>systems/fcs/rcs-entry-roll-compensation-veto</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<value>0.55</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-down-fire-yaw">
		<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-rot-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-down-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-yaw-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod1-down-fire-yaw</property>
				<property>systems/rcs/rudder-rot-cmd-norm-filtered</property>
				<property>systems/fcs/rcs-entry-roll-compensation-veto</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<value>-0.55</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-up-fire-yaw">
		<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-rot-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-up-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-yaw-mode</property>
				<property>systems/fcs/rcs-thrust-factor-rotation</property>
				<property>systems/rcs/pod2-up-fire-yaw</property>
				<property>systems/rcs/rudder-rot-cmd-norm-filtered</property>
				<property>systems/fcs/rcs-entry-roll-compensation-veto</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<value>-0.55</value>
			</product>
		</function>
		</fcs_function>


	<!-- translation x-axis thrust patterns -->

		<switch name="systems/rcs/pod1-back-fire-x">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-back-raw-x">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod1-back-fire-x</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-back-fire-x">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-back-raw-x">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod2-back-fire-x</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-up-fire-x">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-cmd-norm-filtered LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-up-raw-x">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/nose-up-fire-x</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<value>-0.041</value>
			</product>
		</function>
		</fcs_function>


		

		<switch name="systems/rcs/nose-fwd-fire-x">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-fwd-raw-x">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/nose-fwd-fire-x</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-down-fire-x">
			<default value="0.0"/>
			<test value="1.0">
				systems/rcs/rudder-cmd-norm-filtered GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-down-raw-x">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/nose-down-fire-x</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<value>0.175</value>
			</product>
		</function>
		</fcs_function>


		<!-- translations z-axis thrust patterns -->

		<switch name="systems/rcs/nose-up-fire-z">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/elevator-cmd-norm-sense LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-up-raw-z">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/nose-up-fire-z</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-up-fire-z">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/elevator-cmd-norm-sense LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-up-raw-z">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod1-up-fire-z</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<difference>
				<value>-0.61</value>
				<product>
					<property>systems/various/oms-fuel-fraction</property>
					<value>0.1</value>
				</product>
				</difference>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-up-fire-z">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/elevator-cmd-norm-sense LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-up-raw-z">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod2-up-fire-z</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<difference>
				<value>-0.61</value>
				<product>
					<property>systems/various/oms-fuel-fraction</property>
					<value>0.1</value>
				</product>
				</difference>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/rcs/nose-down-fire-z">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/elevator-cmd-norm-sense GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-down-raw-z">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/nose-down-fire-z</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<value>1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-down-fire-z">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/elevator-cmd-norm-sense GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-down-raw-z">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod1-down-fire-z</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<sum>
				<value>0.635</value>
				<product>
					<property>systems/various/oms-fuel-fraction</property>
					<value>0.1</value>
				</product>
				</sum>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-down-fire-z">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/elevator-cmd-norm-sense GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-down-raw-z">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod2-down-fire-z</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<sum>
				<value>0.635</value>
				<product>
					<property>systems/various/oms-fuel-fraction</property>
					<value>0.1</value>
				</product>
				</sum>
			</product>
		</function>
		</fcs_function>


	<!-- translations y-axis thrust patterns -->

		<switch name="systems/rcs/nose-left-fire-y">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-cmd-norm-sense GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-left-raw-y">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/nose-left-fire-y</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<value>1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-left-fire-y">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-cmd-norm-sense GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-left-raw-y">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod1-left-fire-y</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<sum>
				<value>0.635</value>
				<product>
					<property>systems/various/oms-fuel-fraction</property>
					<value>0.1</value>
				</product>
				</sum>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-up-fire-y">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-cmd-norm-sense GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-up-raw-y">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod1-up-fire-y</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<value>0.13</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-down-fire-y">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-cmd-norm-sense GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-down-raw-y">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod2-down-fire-y</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<value>0.13</value>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/rcs/nose-right-fire-y">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-cmd-norm-sense LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-right-raw-y">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/nose-right-fire-y</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-right-fire-y">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-cmd-norm-sense LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-right-raw-y">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod2-right-fire-y</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<difference>
				<value>-0.635</value>
				<product>
					<property>systems/various/oms-fuel-fraction</property>
					<value>0.1</value>
				</product>
				</difference>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-up-fire-y">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-cmd-norm-sense LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-up-raw-y">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod2-up-fire-y</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<value>-0.13</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-down-fire-y">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/aileron-cmd-norm-sense LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-down-raw-y">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor-translation</property>
				<property>systems/rcs/pod1-down-fire-y</property>
				<property>systems/fcs/rcs-modemixing-damper</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<value>-0.13</value>
			</product>
		</function>
		</fcs_function>


	<!-- Postprocessing of the raw channel inputs into actual thrust commands -->



		<!-- for the low-z modes, upward firing thrusters have to be converted to forward/backward -->

		<fcs_function name="systems/rcs/nose-pods-low-z-raw">
		<function>
			<product>
				<max>
					<property>systems/rcs/nose-up-raw-z</property>
					<property>systems/rcs/pod1-up-raw-z</property>
					<property>systems/rcs/pod2-up-raw-z</property>
				</max>
				<difference>
					<value>1.0</value>
					<property>systems/fcs/rcs-low-z</property>
				</difference>
			</product>
		</function>
		</fcs_function>

		<!-- now sum channels for the individual modules -->

		<fcs_function name="systems/rcs/nose-fwd-raw">
		<function>
			<sum>
				<property>systems/rcs/nose-fwd-raw-x</property>
				<property>systems/rcs/nose-pods-low-z-raw</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/nose-leftdown-raw">
		<function>
			<sum>	
				<property>systems/rcs/nose-leftdown-raw-roll</property>
				<property>systems/rcs/nose-down-raw-pitch</property>
				<property>systems/rcs/nose-down-raw-x</property>
				<property>systems/rcs/nose-down-raw-z</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/nose-rightdown-raw">
		<function>
			<sum>	
				<property>systems/rcs/nose-rightdown-raw-roll</property>
				<property>systems/rcs/nose-down-raw-pitch</property>
				<property>systems/rcs/nose-down-raw-x</property>
				<property>systems/rcs/nose-down-raw-z</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/nose-leftup-raw">
		<function>
			<sum>
				<property>systems/rcs/nose-leftup-raw-roll</property>
				<property>systems/rcs/nose-up-raw-pitch</property>
				<property>systems/rcs/nose-up-raw-x</property>
				<property>systems/rcs/nose-up-raw-z</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/nose-centerup-raw">
		<function>
			<sum>
				<property>systems/rcs/nose-up-raw-pitch</property>
				<property>systems/rcs/nose-up-raw-x</property>
				<property>systems/rcs/nose-up-raw-z</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/nose-rightup-raw">
		<function>
			<sum>
				<property>systems/rcs/nose-rightup-raw-roll</property>
				<property>systems/rcs/nose-up-raw-pitch</property>
				<property>systems/rcs/nose-up-raw-x</property>
				<property>systems/rcs/nose-up-raw-z</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/nose-left-raw">
		<function>
			<sum>
				<property>systems/rcs/nose-left-raw-roll</property>
				<property>systems/rcs/nose-left-raw-yaw</property>
				<property>systems/rcs/nose-left-raw-y</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/nose-right-raw">
		<function>
			<sum>
				<property>systems/rcs/nose-right-raw-roll</property>
				<property>systems/rcs/nose-right-raw-yaw</property>
				<property>systems/rcs/nose-right-raw-y</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod1-back-raw">
		<function>
			<sum>
				<property>systems/rcs/pod1-back-raw-x</property>
				<property>systems/rcs/nose-pods-low-z-raw</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod1-up-raw">
		<function>
			<sum>
				<property>systems/rcs/pod1-up-raw-roll</property>
				<property>systems/rcs/pod1-up-raw-pitch</property>
				<property>systems/rcs/pod1-up-raw-yaw</property>
				<!--<property>systems/rcs/pod1-up-raw-x</property>-->
				<property>systems/rcs/pod1-up-raw-y</property>
				<property>systems/rcs/pod1-up-raw-z</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/rcs/pod1-down-raw">
		<function>
			<sum>
				<property>systems/rcs/pod1-down-raw-roll</property>
				<property>systems/rcs/pod1-down-raw-pitch</property>
				<property>systems/rcs/pod1-down-raw-yaw</property>
				<!--<property>systems/rcs/pod1-down-raw-x</property>-->
				<property>systems/rcs/pod1-down-raw-y</property>
				<property>systems/rcs/pod1-down-raw-z</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod1-left-raw">
		<function>
			<sum>
				<property>systems/rcs/pod1-left-raw-yaw</property>
				<property>systems/rcs/pod1-left-raw-y</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod2-back-raw">
		<function>
			<sum>
				<property>systems/rcs/pod2-back-raw-x</property>
				<property>systems/rcs/nose-pods-low-z-raw</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/rcs/pod2-up-raw">
		<function>
			<sum>
				<property>systems/rcs/pod2-up-raw-roll</property>
				<property>systems/rcs/pod2-up-raw-pitch</property>
				<property>systems/rcs/pod2-up-raw-yaw</property>
				<!--<property>systems/rcs/pod2-up-raw-x</property>-->
				<property>systems/rcs/pod2-up-raw-y</property>
				<property>systems/rcs/pod2-up-raw-z</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/rcs/pod2-down-raw">
		<function>
			<sum>
				<property>systems/rcs/pod2-down-raw-roll</property>
				<property>systems/rcs/pod2-down-raw-pitch</property>
				<property>systems/rcs/pod2-down-raw-yaw</property>
				<!--<property>systems/rcs/pod2-down-raw-x</property>-->
				<property>systems/rcs/pod2-down-raw-y</property>
				<property>systems/rcs/pod2-down-raw-z</property>
			</sum>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod2-right-raw">
		<function>
			<sum>
				<property>systems/rcs/pod2-right-raw-yaw</property>
				<property>systems/rcs/pod2-right-raw-y</property>
			</sum>
		</function>
		</fcs_function>

	<!-- subtract thruster commands which would cancel each other out -->
	<!-- firing opposing thrusters is wasteful -->


		<fcs_function name="systems/rcs/nose-left-subtracted">
		<function>
			<max>
			<difference>
				<property>systems/rcs/nose-left-raw</property>
				<property>systems/rcs/nose-right-raw</property>
			</difference>
			<value>0.0</value>
			</max>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/nose-right-subtracted">
		<function>
			<max>
			<difference>
				<property>systems/rcs/nose-right-raw</property>
				<property>systems/rcs/nose-left-raw</property>
			</difference>
			<value>0.0</value>
			</max>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod1-left-subtracted">
		<function>
			<max>
			<difference>
				<property>systems/rcs/pod1-left-raw</property>
				<property>systems/rcs/pod2-right-raw</property>
			</difference>
			<value>0.0</value>
			</max>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod1-up-subtracted">
		<function>
			<max>
			<difference>
				<property>systems/rcs/pod1-up-raw</property>
				<property>systems/rcs/pod1-down-raw</property>
			</difference>
			<value>0.0</value>
			</max>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod1-down-subtracted">
		<function>
			<max>
			<difference>
				<property>systems/rcs/pod1-down-raw</property>
				<property>systems/rcs/pod1-up-raw</property>
			</difference>
			<value>0.0</value>
			</max>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod2-right-subtracted">
		<function>
			<max>
			<difference>
				<property>systems/rcs/pod2-right-raw</property>
				<property>systems/rcs/pod1-left-raw</property>
			</difference>
			<value>0.0</value>
			</max>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod2-up-subtracted">
		<function>
			<max>
			<difference>
				<property>systems/rcs/pod2-up-raw</property>
				<property>systems/rcs/pod2-down-raw</property>
			</difference>
			<value>0.0</value>
			</max>
		</function>
		</fcs_function>

		<fcs_function name="systems/rcs/pod2-down-subtracted">
		<function>
			<max>
			<difference>
				<property>systems/rcs/pod2-down-raw</property>
				<property>systems/rcs/pod2-up-raw</property>
			</difference>
			<value>0.0</value>
			</max>
		</function>
		</fcs_function>

	<!-- then normalize thrust pattern -->


		<fcs_function name="systems/rcs/thrust-normalizer">
			<function>
				<max>
				<value>1.0</value>
				<property>systems/rcs/nose-up-raw</property>
				<property>systems/rcs/nose-down-raw</property>
				<property>systems/rcs/nose-left-subtracted</property>
				<property>systems/rcs/nose-right-subtracted</property>
				<property>systems/rcs/pod1-up-subtracted</property>
				<property>systems/rcs/pod2-up-subtracted</property>
				<property>systems/rcs/pod1-down-subtracted</property>
				<property>systems/rcs/pod2-down-subtracted</property>
				<property>systems/rcs/pod1-left-subtracted</property>
				<property>systems/rcs/pod2-right-subtracted</property>
				</max>
			</function>
		</fcs_function>




	<!-- then assign the commands to actual thrusters - first the default set -->



		<fcs_function name="systems/rcs/thrust-nose-left">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/nose-left-subtracted</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-nose-active-yaw</property>
			<property>systems/failures/rcs-nose-left-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
			<property>systems/rcs/fwd-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/F1L-fire-cmd</output>
		<output>systems/rcs/F3L-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-right">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/nose-right-subtracted</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-nose-active-yaw</property>
			<property>systems/failures/rcs-nose-right-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
			<property>systems/rcs/fwd-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/F2R-fire-cmd</output>
		<output>systems/rcs/F4R-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-fwd">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/nose-fwd-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-nose-active</property>
			<property>systems/failures/rcs-nose-fwd-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
		</function>
		<output>systems/rcs/F2F-fire-cmd</output>
		<output>systems/rcs/F3F-fire-cmd</output>
		<output>systems/rcs/F1F-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-leftdown">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/nose-leftdown-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-nose-active-pitch</property>
			<property>systems/failures/rcs-nose-fwd-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
		</function>
		<output>systems/rcs/F1D-fire-cmd</output>
		<output>systems/rcs/F3D-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-rightdown">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/nose-rightdown-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-nose-active-pitch</property>
			<property>systems/failures/rcs-nose-fwd-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
		</function>
		<output>systems/rcs/F2D-fire-cmd</output>
		<output>systems/rcs/F4D-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-leftup">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/nose-leftup-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-nose-active-pitch</property>
			<property>systems/failures/rcs-nose-fwd-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			<property>systems/fcs/rcs-low-z</property>
			</product>
		</function>
		<output>systems/rcs/F1U-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-centerup">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/nose-centerup-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-nose-active-pitch</property>
			<property>systems/failures/rcs-nose-fwd-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			<property>systems/fcs/rcs-low-z</property>
			</product>
		</function>
		<output>systems/rcs/F3U-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-rightup">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/nose-rightup-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-nose-active-pitch</property>
			<property>systems/failures/rcs-nose-fwd-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			<property>systems/fcs/rcs-low-z</property>
			</product>
		</function>
		<output>systems/rcs/F2U-fire-cmd</output>
		</fcs_function>


		<fcs_function name="systems/rcs/thrust-pod1-up">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/pod1-up-subtracted</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-tail-active-pitch</property>
			<property>systems/failures/rcs-pod1-up-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			<property>systems/fcs/rcs-low-z</property>
			</product>
			<property>systems/oms/oms-rcs-dump-cmd</property>
			<property>systems/rcs/aft-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/L4U-fire-cmd</output>
		<output>systems/rcs/L2U-fire-cmd</output>
		<output>systems/rcs/L1U-fire-cmd</output>
		</fcs_function>


		<fcs_function name="systems/rcs/thrust-pod1-down">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/pod1-down-subtracted</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-tail-active-pitch</property>
			<property>systems/failures/rcs-pod1-down-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
			<property>systems/oms/oms-rcs-dump-cmd</property>
			<property>systems/rcs/aft-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/L4D-fire-cmd</output>
		<output>systems/rcs/L2D-fire-cmd</output>
		<output>systems/rcs/L3D-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-pod1-left">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/pod1-left-subtracted</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-tail-active-yaw</property>
			<property>systems/failures/rcs-pod1-left-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
			<property>systems/oms/oms-rcs-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/L4L-fire-cmd</output>
		<output>systems/rcs/L2L-fire-cmd</output>
		<output>systems/rcs/L3L-fire-cmd</output>
		<output>systems/rcs/L1L-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-pod1-back">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/pod1-back-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-tail-active</property>
			<property>systems/failures/rcs-pod1-back-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
			<property>systems/oms/oms-rcs-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/L3A-fire-cmd</output>
		<output>systems/rcs/L1A-fire-cmd</output>
		</fcs_function>


		<fcs_function name="systems/rcs/thrust-pod2-up">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/pod2-up-subtracted</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-tail-active-pitch</property>
			<property>systems/failures/rcs-pod2-up-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			<property>systems/fcs/rcs-low-z</property>
			</product>
			<property>systems/oms/oms-rcs-dump-cmd</property>
			<property>systems/rcs/aft-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/R4U-fire-cmd</output>
		<output>systems/rcs/R2U-fire-cmd</output>
		<output>systems/rcs/R1U-fire-cmd</output>
		</fcs_function>


		<fcs_function name="systems/rcs/thrust-pod2-down">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/pod2-down-subtracted</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-tail-active-pitch</property>
			<property>systems/failures/rcs-pod2-down-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
			<property>systems/oms/oms-rcs-dump-cmd</property>
			<property>systems/rcs/aft-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/R4D-fire-cmd</output>
		<output>systems/rcs/R2D-fire-cmd</output>
		<output>systems/rcs/R3D-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-pod2-right">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/pod2-right-subtracted</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-tail-active-yaw</property>
			<property>systems/failures/rcs-pod2-right-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
			<property>systems/oms/oms-rcs-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/R4R-fire-cmd</output>
		<output>systems/rcs/R2R-fire-cmd</output>
		<output>systems/rcs/R3R-fire-cmd</output>
		<output>systems/rcs/R1R-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-pod2-back">
		<function>
			<max>
			<product>
			<quotient>
				<property>systems/rcs/pod2-back-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<property>systems/fcs/rcs-tail-active</property>
			<property>systems/failures/rcs-pod2-back-condition</property>
			<property>systems/fcs/rcs-default-thrusters</property>
			</product>
			<property>systems/oms/oms-rcs-dump-cmd</property>
			</max>
		</function>
		<output>systems/rcs/R3A-fire-cmd</output>
		<output>systems/rcs/R1A-fire-cmd</output>
		</fcs_function>



	<!-- Vernier thrusters -->


		<fcs_function name="systems/rcs/thrust-vernier-nose-right">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/nose-rightdown-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<!--<property>systems/fcs/rcs-nose-active</property>-->
			<property>systems/failures/rcs-nose-right-condition</property>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/rcs-default-thrusters</property>
			</difference>
			</product>
		</function>
		<output>systems/rcs/F5R-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-vernier-nose-left">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/nose-leftdown-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<!--<property>systems/fcs/rcs-nose-active</property>-->
			<property>systems/failures/rcs-nose-left-condition</property>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/rcs-default-thrusters</property>
			</difference>
			</product>
		</function>
		<output>systems/rcs/F5L-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-vernier-pod1-down">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/pod1-down-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<!--<property>systems/fcs/rcs-tail-active</property>-->
			<property>systems/failures/rcs-pod1-down-condition</property>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/rcs-default-thrusters</property>
			</difference>
			</product>
		</function>
		<output>systems/rcs/L5D-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-vernier-pod2-down">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/pod2-down-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<!--<property>systems/fcs/rcs-tail-active</property>-->
			<property>systems/failures/rcs-pod2-down-condition</property>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/rcs-default-thrusters</property>
			</difference>
			</product>
		</function>
		<output>systems/rcs/R5D-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-vernier-pod1-left">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/pod1-left-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<!--<property>systems/fcs/rcs-tail-active</property>-->
			<property>systems/failures/rcs-pod1-left-condition</property>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/rcs-default-thrusters</property>
			</difference>
			</product>
		</function>
		<output>systems/rcs/L5L-fire-cmd</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-vernier-pod2-right">
		<function>
			<product>
			<quotient>
				<property>systems/rcs/pod2-right-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
			<!--<property>systems/fcs/rcs-tail-active</property>-->
			<property>systems/failures/rcs-pod2-right-condition</property>
			<difference>
				<value>1.0</value>
				<property>systems/fcs/rcs-default-thrusters</property>
			</difference>
			</product>
		</function>
		<output>systems/rcs/R5R-fire-cmd</output>
		</fcs_function>

		<!--<fcs_function name="systems/fcs/rcs-throttle-test">
			<function>
				<value>1.0</value>
			</function>
			<output>fcs/throttle-pos-norm[48]</output>
			<output>fcs/throttle-pos-norm[49]</output>
			<output>fcs/throttle-pos-norm[50]</output>
			<output>fcs/throttle-pos-norm[57]</output>
			<output>fcs/throttle-pos-norm[58]</output>
			<output>fcs/throttle-pos-norm[59]</output>
		</fcs_function>-->

	</channel>

</system>
