<?xml version="1.0"?>

<system>

	<channel name="RCS controls">

		<!-- zero all unused thrusters -->
		<fcs_function name="systems/fcs/rcs-throttle-zero">
			<function>
				<value>0.0</value>
			</function>
		<!--<output>fcs/throttle-pos-norm[7]</output>-->
		<!--<output>fcs/throttle-pos-norm[8]</output>-->
		<!--<output>fcs/throttle-pos-norm[9]</output>-->
		<!--<output>fcs/throttle-pos-norm[10]</output>-->
		<output>fcs/throttle-pos-norm[11]</output>
		<!--<output>fcs/throttle-pos-norm[12]</output>-->
		<!--<output>fcs/throttle-pos-norm[13]</output>-->
		<!--<output>fcs/throttle-pos-norm[14]</output>-->
		<output>fcs/throttle-pos-norm[15]</output>
		<output>fcs/throttle-pos-norm[16]</output>
		<!--<output>fcs/throttle-pos-norm[17]</output>-->
		<!--<output>fcs/throttle-pos-norm[18]</output>-->
		<output>fcs/throttle-pos-norm[19]</output>
		<!--<output>fcs/throttle-pos-norm[20]</output>-->
		<output>fcs/throttle-pos-norm[21]</output>
		</fcs_function>


		<switch name="systems/fcs/rcs-thrust-factor">
			<default value="0.0"/>
			<test value="1.0">
				systems/fcs/control-mode == 1
			</test>
		</switch>

	<!-- we pre-filter the commands to get more sensitive response at low thrust -->


		<fcs_function name="systems/rcs/aileron-cmd-norm-filtered">
			<function>
				<product>
					<property>fcs/aileron-cmd-norm</property>
				<abs>
					<property>fcs/aileron-cmd-norm</property>
				</abs>
				</product>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/elevator-cmd-norm-filtered">
			<function>
				<product>
					<property>fcs/elevator-cmd-norm</property>
				<abs>
					<property>fcs/elevator-cmd-norm</property>
				</abs>
				</product>
			</function>
		</fcs_function>

		<fcs_function name="systems/rcs/rudder-cmd-norm-filtered">
			<function>
				<product>
					<property>fcs/rudder-cmd-norm</property>
				<abs>
					<property>fcs/rudder-cmd-norm</property>
				</abs>
				</product>
			</function>
		</fcs_function>

	<!-- roll thrust patterns -->

		<switch name="systems/rcs/pod1-up-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				fcs/aileron-cmd-norm LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-up-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod1-up-fire-roll</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-down-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				fcs/aileron-cmd-norm GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-down-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod1-down-fire-roll</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-up-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				fcs/aileron-cmd-norm GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-up-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod2-up-fire-roll</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-down-fire-roll">
			<default value="0.0"/>
			<test value="1.0">
				fcs/aileron-cmd-norm LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-down-raw-roll">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod2-down-fire-roll</property>
				<property>systems/rcs/aileron-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

	<!-- pitch thrust patterns -->

		<switch name="systems/rcs/nose-up-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				fcs/elevator-cmd-norm GT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/nose-up-raw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/nose-up-fire-pitch</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-down-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				fcs/elevator-cmd-norm LT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/nose-down-raw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/nose-down-fire-pitch</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/rcs/pod1-up-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				fcs/elevator-cmd-norm LT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/pod1-up-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod1-up-fire-pitch</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<value>-0.5</value>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/rcs/pod2-up-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				fcs/elevator-cmd-norm LT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/pod2-up-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod2-up-fire-pitch</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<value>-0.5</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-down-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				fcs/elevator-cmd-norm GT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/pod1-down-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod1-down-fire-pitch</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<value>0.5</value>
			</product>
		</function>
		</fcs_function>


		<switch name="systems/rcs/pod2-down-fire-pitch">
			<default value="0.0"/>
			<test value="1.0">
				fcs/elevator-cmd-norm GT 0
			</test>
		</switch>


		<fcs_function name="systems/rcs/pod2-down-raw-pitch">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod2-down-fire-pitch</property>
				<property>systems/rcs/elevator-cmd-norm-filtered</property>
				<value>0.5</value>
			</product>
		</function>
		</fcs_function>

	<!-- yaw thrust patterns -->

		<switch name="systems/rcs/nose-left-fire-yaw">
			<default value="0.0"/>
			<test value="1.0">
				fcs/rudder-cmd-norm LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-left-raw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/nose-left-fire-yaw</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/nose-right-fire-yaw">
			<default value="0.0"/>
			<test value="1.0">
				fcs/rudder-cmd-norm GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/nose-right-raw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/nose-right-fire-yaw</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-left-fire-yaw">
			<default value="0.0"/>
			<test value="1.0">
				fcs/rudder-cmd-norm GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-left-raw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod1-left-fire-yaw</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-right-fire-yaw">
			<default value="0.0"/>
			<test value="1.0">
				fcs/rudder-cmd-norm LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-right-raw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod2-right-fire-yaw</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<value>-1.0</value>
			</product>
		</function>
		</fcs_function>

		<!-- since pod thrusters are higher than nose, firing yaw causes a roll moment-->
		<!-- which needs to be compensated -->

		<switch name="systems/rcs/pod1-up-fire-yaw">
		<default value="0.0"/>
			<test value="1.0">
				fcs/rudder-cmd-norm GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-up-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod1-up-fire-yaw</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<value>0.66</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-down-fire-yaw">
		<default value="0.0"/>
			<test value="1.0">
				fcs/rudder-cmd-norm GT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-down-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod2-down-fire-yaw</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<value>0.66</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod1-down-fire-yaw">
		<default value="0.0"/>
			<test value="1.0">
				fcs/rudder-cmd-norm LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod1-down-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod1-down-fire-yaw</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<value>-0.66</value>
			</product>
		</function>
		</fcs_function>

		<switch name="systems/rcs/pod2-up-fire-yaw">
		<default value="0.0"/>
			<test value="1.0">
				fcs/rudder-cmd-norm LT 0
			</test>
		</switch>

		<fcs_function name="systems/rcs/pod2-up-raw-yaw">
		<function>
			<product>
				<property>systems/fcs/rcs-thrust-factor</property>
				<property>systems/rcs/pod2-up-fire-yaw</property>
				<property>systems/rcs/rudder-cmd-norm-filtered</property>
				<value>-0.66</value>
			</product>
		</function>
		</fcs_function>


	<!-- Postprocessing of the raw channel inputs into actual thrust commands -->

	<!-- first sum all individual signals -->

		<fcs_function name="systems/rcs/pod1-up-raw">
		<function>
			<sum>
				<property>systems/rcs/pod1-up-raw-roll</property>
				<property>systems/rcs/pod1-up-raw-pitch</property>
				<property>systems/rcs/pod1-up-raw-yaw</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/rcs/pod1-down-raw">
		<function>
			<sum>
				<property>systems/rcs/pod1-down-raw-roll</property>
				<property>systems/rcs/pod1-down-raw-pitch</property>
				<property>systems/rcs/pod1-down-raw-yaw</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/rcs/pod2-up-raw">
		<function>
			<sum>
				<property>systems/rcs/pod2-up-raw-roll</property>
				<property>systems/rcs/pod2-up-raw-pitch</property>
				<property>systems/rcs/pod2-up-raw-yaw</property>
			</sum>
		</function>
		</fcs_function>


		<fcs_function name="systems/rcs/pod2-down-raw">
		<function>
			<sum>
				<property>systems/rcs/pod2-down-raw-roll</property>
				<property>systems/rcs/pod2-down-raw-pitch</property>
				<property>systems/rcs/pod2-down-raw-yaw</property>
			</sum>
		</function>
		</fcs_function>

	<!-- then normalize thrust pattern -->


		<fcs_function name="systems/rcs/thrust-normalizer">
			<function>
				<max>
				<value>1.0</value>
				<property>systems/rcs/nose-up-raw</property>
				<property>systems/rcs/nose-down-raw</property>
				<property>systems/rcs/nose-left-raw</property>
				<property>systems/rcs/nose-right-raw</property>
				<property>systems/rcs/pod1-up-raw</property>
				<property>systems/rcs/pod2-up-raw</property>
				<property>systems/rcs/pod1-down-raw</property>
				<property>systems/rcs/pod2-down-raw</property>
				<property>systems/rcs/pod1-left-raw</property>
				<property>systems/rcs/pod2-right-raw</property>
				</max>
			</function>
		</fcs_function>



	<!-- then assign to thrusters -->


		<fcs_function name="systems/rcs/thrust-nose-up">
		<function>
			<quotient>
				<property>systems/rcs/nose-up-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[7]</output>
		</fcs_function>


		<fcs_function name="systems/rcs/thrust-nose-down">
		<function>
			<quotient>
				<property>systems/rcs/nose-down-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[8]</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-left">
		<function>
			<quotient>
				<property>systems/rcs/nose-left-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[9]</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-nose-right">
		<function>
			<quotient>
				<property>systems/rcs/nose-right-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[10]</output>
		</fcs_function>



		<fcs_function name="systems/rcs/thrust-pod1-up">
		<function>
			<quotient>
				<property>systems/rcs/pod1-up-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[12]</output>
		</fcs_function>


		<fcs_function name="systems/rcs/thrust-pod1-down">
		<function>
			<quotient>
				<property>systems/rcs/pod1-down-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[13]</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-pod1-left">
		<function>
			<quotient>
				<property>systems/rcs/pod1-left-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[14]</output>
		</fcs_function>


		<fcs_function name="systems/rcs/thrust-pod2-up">
		<function>
			<quotient>
				<property>systems/rcs/pod2-up-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[17]</output>
		</fcs_function>


		<fcs_function name="systems/rcs/thrust-pod2-down">
		<function>
			<quotient>
				<property>systems/rcs/pod2-down-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[18]</output>
		</fcs_function>

		<fcs_function name="systems/rcs/thrust-pod2-right">
		<function>
			<quotient>
				<property>systems/rcs/pod2-right-raw</property>
				<property>systems/rcs/thrust-normalizer</property>
			</quotient>
		</function>
		<output>fcs/throttle-pos-norm[20]</output>
		</fcs_function>
	</channel>

</system>
